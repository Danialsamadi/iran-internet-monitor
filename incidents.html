<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#0a0e17">
    <title>Incidents — Iran Internet Monitor</title>
    <meta name="description"
        content="Network incident timeline — current status, affected services, and historical incidents.">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        :root {
            --bg: #0a0e17;
            --bg2: #0f1520;
            --bg3: #141c2b;
            --card: #121a29;
            --card2: #16202f;
            --border: #1e2d44;
            --border2: #253650;
            --text: #e8ecf4;
            --text2: #9aa5b8;
            --text3: #5c6a82;
            --green: #2ecc71;
            --green2: #27ae60;
            --green-g: rgba(46, 204, 113, 0.15);
            --yellow: #f1c40f;
            --yellow2: #e67e22;
            --yellow-g: rgba(241, 196, 15, 0.15);
            --red: #e74c3c;
            --red2: #c0392b;
            --red-g: rgba(231, 76, 60, 0.15);
            --accent: #25aff4;
            --accent-g: rgba(37, 175, 244, 0.15);
            --cyan: #25aff4;
            --purple: #7c3aed;
            --blue: #3b82f6;
            --font: 'Inter', system-ui, -apple-system, sans-serif;
            --r: 8px;
            --r2: 8px;
            --touch: 44px;
        }

        body {
            font-family: var(--font);
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased
        }

        body::before {
            content: '';
            position: fixed;
            top: -40%;
            left: -20%;
            width: 140%;
            height: 100%;
            background: radial-gradient(ellipse at 30% 20%, rgba(37, 175, 244, 0.07), transparent 60%), radial-gradient(ellipse at 70% 60%, rgba(124, 58, 237, 0.05), transparent 50%), radial-gradient(ellipse at 50% 80%, rgba(231, 76, 60, 0.04), transparent 50%);
            pointer-events: none;
            z-index: 0
        }

        .nav {
            background: rgba(15, 21, 32, 0.85);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100
        }

        .nav-inner {
            max-width: 1380px;
            margin: 0 auto;
            padding: 0 28px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 52px
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: var(--text)
        }

        .nav-brand svg {
            width: 26px;
            height: 26px
        }

        .nav-brand span {
            font-size: 14px;
            font-weight: 700;
            letter-spacing: -.3px
        }

        .nav-links {
            display: flex;
            gap: 2px
        }

        .nav-links a {
            color: var(--text2);
            text-decoration: none;
            font-size: 12px;
            font-weight: 500;
            padding: 6px 14px;
            border-radius: 6px;
            transition: .2s
        }

        .nav-links a:hover,
        .nav-links a.active {
            color: var(--text);
            background: var(--card)
        }

        .nav-links a.active {
            border-bottom: 2px solid var(--accent);
            color: var(--accent)
        }

        .nav-ts {
            font-size: 11px;
            color: var(--text3);
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
            line-height: 1.3
        }

        .nav-ts .clock-row {
            display: flex;
            align-items: center;
            gap: 5px
        }

        .nav-ts .clock-label {
            color: var(--text3);
            opacity: .7
        }

        .nav-ts .clock-val {
            color: var(--text2);
            font-variant-numeric: tabular-nums
        }

        .wrap {
            max-width: 1380px;
            margin: 0 auto;
            padding: 20px 28px 60px;
            position: relative;
            z-index: 1
        }

        .page-title {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -.3px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px
        }

        .page-title svg {
            width: 24px;
            height: 24px
        }

        /* Grid */
        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px
        }

        /* Card */
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--r2);
            padding: 20px;
            position: relative;
            overflow: hidden;
            margin-bottom: 16px
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(37, 175, 244, 0.2), transparent)
        }

        .card-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text2);
            text-transform: uppercase;
            letter-spacing: .6px;
            margin-bottom: 14px
        }

        /* Donut */
        .donut-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px
        }

        .donut-wrap {
            position: relative;
            width: 120px;
            height: 120px
        }

        .donut-wrap svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg)
        }

        .donut-bg {
            fill: none;
            stroke: var(--border);
            stroke-width: 10
        }

        .donut-seg {
            fill: none;
            stroke-width: 10;
            stroke-linecap: round;
            transition: stroke-dashoffset 1s ease
        }

        .donut-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center
        }

        .donut-legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            color: var(--text2)
        }

        .donut-legend-item .dl-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%
        }

        .donut-pct-center {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 800
        }

        /* Count badges */
        .count-row {
            display: flex;
            gap: 12px;
            margin-top: 10px;
            justify-content: center;
            flex-wrap: wrap
        }

        .count-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 600;
            padding: 6px 14px;
            border-radius: 8px;
            background: var(--card2);
            border: 1px solid var(--border)
        }

        .count-num {
            font-size: 18px;
            font-weight: 800
        }

        /* Incident timeline */
        .timeline {
            position: relative;
            padding-left: 28px
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border)
        }

        .tl-item {
            position: relative;
            margin-bottom: 20px
        }

        .tl-dot {
            position: absolute;
            left: -24px;
            top: 4px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid var(--bg);
            z-index: 2
        }

        .tl-dot.critical {
            background: var(--red);
            box-shadow: 0 0 8px var(--red)
        }

        .tl-dot.major {
            background: var(--yellow);
            box-shadow: 0 0 8px var(--yellow)
        }

        .tl-dot.minor {
            background: var(--accent);
            box-shadow: 0 0 6px var(--accent)
        }

        .tl-dot.resolved {
            background: var(--green);
            box-shadow: 0 0 6px var(--green)
        }

        .tl-time {
            font-size: 10px;
            color: var(--text3);
            margin-bottom: 4px;
            font-weight: 500
        }

        .inc-box {
            background: var(--card2);
            border: 1px solid var(--border);
            border-left: 3px solid var(--red);
            border-radius: var(--r);
            padding: 14px 16px;
            transition: .2s
        }

        .inc-box:hover {
            border-color: var(--border2)
        }

        .inc-box.degraded {
            border-left-color: var(--yellow)
        }

        .inc-box.resolved {
            border-left-color: var(--green)
        }

        .inc-box.minor {
            border-left-color: var(--cyan)
        }

        .inc-h {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: .3px
        }

        .inc-affected {
            font-size: 11px;
            color: var(--text3);
            margin: 4px 0
        }

        .inc-affected strong {
            color: var(--text2)
        }

        .inc-detail {
            display: flex;
            gap: 14px;
            font-size: 11px;
            color: var(--text3);
            margin-top: 6px;
            flex-wrap: wrap
        }

        .inc-detail span {
            display: flex;
            align-items: center;
            gap: 4px
        }

        .inc-badge {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 4px;
            display: inline-block
        }

        .inc-badge.down {
            background: var(--red-g);
            color: var(--red)
        }

        .inc-badge.degraded {
            background: var(--yellow-g);
            color: var(--yellow)
        }

        .inc-badge.resolved {
            background: var(--green-g);
            color: var(--green)
        }

        .inc-badge.investigating {
            background: var(--accent-g);
            color: var(--accent)
        }

        .svc-type-badge {
            font-size: 9px;
            font-weight: 600;
            padding: 1px 5px;
            border-radius: 3px;
            text-transform: uppercase;
            letter-spacing: .3px;
            flex-shrink: 0;
            display: inline-block;
            margin-left: 6px;
            vertical-align: middle
        }

        .svc-type-badge.tcp {
            background: rgba(124, 58, 237, 0.15);
            color: var(--purple)
        }

        .svc-type-badge.http {
            background: rgba(37, 175, 244, 0.1);
            color: var(--cyan)
        }

        .apex-radial-wrap {
            min-height: 260px;
            margin: 8px 0
        }

        .apex-donut-wrap {
            min-height: 220px;
            margin: 8px 0
        }

        .apex-semi-donut-wrap {
            min-height: 240px;
            margin: 0 0 4px
        }

        .incidents-summary {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 14px
        }

        .incidents-summary .total-line {
            font-size: 12px;
            color: var(--text3);
            margin-top: 4px
        }

        .incidents-summary .total-line strong {
            color: var(--text)
        }

        /* Area chart in incident card */
        .inc-spark {
            height: 140px;
            margin-top: 10px;
            border-radius: var(--r);
            overflow: hidden
        }

        /* Loading / no-data */
        .loading {
            text-align: center;
            padding: 100px 0;
            color: var(--text3)
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin .7s linear infinite;
            margin: 0 auto 12px
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        .no-data {
            text-align: center;
            padding: 80px 20px;
            color: var(--text3)
        }

        .no-data h3 {
            font-size: 18px;
            color: var(--text2);
            margin-bottom: 8px
        }

        .no-data code {
            background: var(--card);
            padding: 4px 10px;
            border-radius: var(--r);
            font-size: 12px;
            color: var(--accent)
        }

        .footer {
            border-top: 1px solid var(--border);
            padding: 24px;
            text-align: center;
            font-size: 11px;
            color: var(--text3);
            margin-top: 40px
        }

        .footer a {
            color: var(--text2);
            text-decoration: none
        }

        .footer a:hover {
            color: var(--text)
        }

        .nav-toggle {
            display: none;
            width: var(--touch);
            height: var(--touch);
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: var(--text);
            cursor: pointer;
            border-radius: var(--r);
            -webkit-tap-highlight-color: transparent
        }

        .nav-toggle:focus-visible { outline: 2px solid var(--accent) }
        .nav-toggle span { display: block; width: 20px; height: 2px; background: currentColor; border-radius: 1px; margin: 6px 0; transition: .2s }
        .nav-toggle span::before, .nav-toggle span::after { content: ''; display: block; width: 20px; height: 2px; background: currentColor; border-radius: 1px; transition: .2s }
        .nav.open .nav-toggle span { background: transparent }
        .nav.open .nav-toggle span::before { transform: translateY(8px) rotate(45deg) }
        .nav.open .nav-toggle span::after { transform: translateY(-8px) rotate(-45deg) }

        @media (max-width: 900px) {
            .grid-3, .grid-2 { grid-template-columns: 1fr }
        }

        @media (max-width: 768px) {
            .nav-inner { padding: 0 16px; min-height: var(--touch) }
            .nav-toggle { display: flex }
            .nav-links {
                position: fixed;
                top: 52px;
                left: 0;
                right: 0;
                background: var(--bg2);
                border-bottom: 1px solid var(--border);
                flex-direction: column;
                padding: 12px;
                gap: 4px;
                transform: translateY(-100%);
                opacity: 0;
                visibility: hidden;
                transition: transform .2s, opacity .2s, visibility .2s;
                z-index: 99;
                box-shadow: 0 8px 24px rgba(0,0,0,.3)
            }
            .nav.open .nav-links { transform: translateY(0); opacity: 1; visibility: visible }
            .nav-links a { padding: 12px 16px; min-height: var(--touch); display: flex; align-items: center; border-radius: var(--r) }
            .nav-ts { display: none }
            .timeline { padding-left: 20px }
            .timeline::before { left: 5px }
            .tl-dot { left: -18px; width: 10px; height: 10px }
        }

        @media (max-width: 600px) {
            .wrap {
                padding: 16px 16px 48px;
                padding-left: max(16px, env(safe-area-inset-left));
                padding-right: max(16px, env(safe-area-inset-right));
                padding-bottom: max(48px, env(safe-area-inset-bottom))
            }
            .page-title { font-size: 18px; flex-wrap: wrap }
            .page-title svg { flex-shrink: 0 }
            .count-row { flex-direction: column }
            .count-badge { min-width: 100%; justify-content: center }
            .inc-box, .inc-h { font-size: 13px }
        }
    </style>
</head>

<body>
    <nav class="nav" id="nav">
        <div class="nav-inner">
            <a href="index.html" class="nav-brand" aria-label="Home"><svg viewBox="0 0 40 40" fill="none" aria-hidden="true">
                    <circle cx="20" cy="20" r="18" fill="var(--accent)" opacity=".15" />
                    <path d="M20 8L28 20l-4 0v12H16V20l-4 0z" fill="var(--accent)" />
                </svg><span>Iran Internet Status</span></a>
            <button type="button" class="nav-toggle" aria-label="Open menu" aria-expanded="false"><span></span></button>
            <div class="nav-links">
                <a href="index.html">Dashboard</a>
                <a href="monitors.html">Monitors</a>
                <a href="incidents.html" class="active">Incidents</a>
                <a href="https://github.com/Danialsamadi/iran-internet-monitor" target="_blank" rel="noopener">GitHub</a>
            </div>
            <div class="nav-ts" id="nav-clock">
                <div class="clock-row"><span class="clock-label">Iran</span><span class="clock-val" id="clock-iran">--:--:--</span></div>
                <div class="clock-row"><span class="clock-label">Local</span><span class="clock-val" id="clock-local">--:--:--</span></div>
            </div>
        </div>
    </nav>
    <script>document.getElementById('nav').addEventListener('click', function(e) {
        if (e.target.closest('.nav-toggle')) {
            this.classList.toggle('open');
            this.querySelector('.nav-toggle').setAttribute('aria-expanded', this.classList.contains('open'));
        }
    });
    (function() {
        function pad(n) { return n < 10 ? '0' + n : n; }
        function tick() {
            var now = new Date();
            var iranEl = document.getElementById('clock-iran');
            var localEl = document.getElementById('clock-local');
            if (iranEl) {
                var iran = now.toLocaleString('en-GB', { timeZone: 'Asia/Tehran', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
                var iranDate = now.toLocaleString('en-GB', { timeZone: 'Asia/Tehran', day: '2-digit', month: 'short' });
                iranEl.textContent = iranDate + ' ' + iran;
            }
            if (localEl) {
                localEl.textContent = pad(now.getDate()) + ' ' + now.toLocaleString('en-GB', { month: 'short' }) + ' ' + pad(now.getHours()) + ':' + pad(now.getMinutes()) + ':' + pad(now.getSeconds());
            }
        }
        tick();
        setInterval(tick, 1000);
    })();</script>

    <div class="wrap">
        <h1 class="page-title"><svg viewBox="0 0 24 24" fill="none" stroke="var(--red)" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" />
                <line x1="12" y1="9" x2="12" y2="13" />
                <line x1="12" y1="17" x2="12.01" y2="17" />
            </svg>Network Incident Timeline Overview</h1>
        <div id="app">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading incident data…</p>
            </div>
        </div>
    </div>
    <div class="footer">
        <p>Powered by <a href="https://github.com/Danialsamadi/iran-internet-monitor">Iran Internet Monitor</a> · Data
            from <a href="https://ioda.inetintel.cc.gatech.edu/">IODA</a> · <a href="https://ooni.org/">OONI</a> · <a
                href="https://atlas.ripe.net/">RIPE</a> · <a href="https://metrics.torproject.org/">Tor</a> · <a
                href="https://psiphon.ca/">Psiphon</a></p>
    </div>

    <script>
        (function () {
            'use strict';
            const DATA_URL = 'api/page-data.json', app = document.getElementById('app');

            function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML }
            function timeAgo(iso) { if (!iso) return ''; const s = Math.floor((Date.now() - new Date(iso)) / 1e3); if (s < 60) return 'just now'; if (s < 3600) return Math.floor(s / 60) + 'm ago'; if (s < 86400) return Math.floor(s / 3600) + 'h ago'; return Math.floor(s / 86400) + 'd ago' }
            function isTcp(svc) { return svc && (svc.check_type === 'tcp' || (svc.id && svc.id.startsWith('ir-tcp-'))) }
            function typeBadge(svc) { return isTcp(svc) ? '<span class="svc-type-badge tcp">TCP</span>' : '<span class="svc-type-badge http">HTTP</span>' }

            // Generate simulated response-time data as [{x: timestamp, y: value}]
            function genChartData(base, n, seed) {
                var s = seed || 100;
                function rr() { s = (s * 16807 + 7) % 2147483647; return (s % 1000) / 1000; }
                var now = Date.now();
                var interval = 300000; // 5 min intervals
                var data = [];
                for (var i = 0; i < n; i++) {
                    var jitter = base * (0.3 + rr() * 1.4);
                    data.push({ x: now - (n - 1 - i) * interval, y: Math.round(jitter) });
                }
                data[n - 1].y = base; // latest = actual value
                return data;
            }

            function render(data) {
                if (!data || !data.summary) { app.innerHTML = '<div class="no-data"><h3>Waiting for Data</h3><p>Push to GitHub & enable Actions to start monitoring.</p><p style="margin-top:10px"><code>./run-check.sh</code></p></div>'; return }

                const sm = data.summary, svcs = data.services || [], cats = data.categories || [];
                const total = sm.total_services || 1;
                const down = svcs.filter(s => s.status === 'down');
                const degraded = svcs.filter(s => s.status === 'degraded');
                const up = svcs.filter(s => s.status === 'up');
                const unknown = svcs.filter(s => s.status === 'unknown');
                const incidents = [...down, ...degraded];

                let h = '';

                // === Top row: Current Status + Recent Incidents (semi-donut) ===
                h += `<div class="grid-3">`;

                const pUp = up.length / total, pDeg = degraded.length / total, pDown = down.length / total, pUnk = unknown.length / total;
                const upPct = Math.round(pUp * 100), degPct = Math.round(pDeg * 100), downPct = Math.round(pDown * 100), unkPct = Math.round(pUnk * 100);

                // Card 1: Current Status (ApexCharts multiple radialbars)
                h += `<div class="card"><div class="card-title">Current Status</div><div id="chart-incidents-status-radial" class="apex-radial-wrap"></div></div>`;

                // Card 2: Recent Incidents — semi-donut showing Critical / Major / Minor
                h += `<div class="card"><div class="card-title">Recent Incidents</div>`;
                h += `<div class="incidents-summary">`;
                h += `<div id="chart-incidents-semi-donut" class="apex-semi-donut-wrap"></div>`;
                h += `<div class="count-row"><div class="count-badge"><span class="count-num" style="color:var(--red)">${down.length}</span>Critical</div><div class="count-badge"><span class="count-num" style="color:var(--yellow)">${degraded.length}</span>Major</div><div class="count-badge"><span class="count-num" style="color:var(--cyan)">${unknown.length}</span>Minor</div></div>`;
                h += `<div class="total-line">Total services monitored: <strong>${total}</strong></div>`;
                h += `</div></div>`;
                h += `</div>`; // end grid-3

                // === Incident Timeline ===
                h += `<div class="grid-2">`;

                // Left column: critical incidents
                h += `<div>`;
                if (incidents.length > 0) {
                    incidents.forEach((svc, i) => {
                        const severity = svc.status === 'down' ? 'critical' : 'major';
                        const boxCls = svc.status === 'degraded' ? 'degraded' : '';
                        const tcpLabel = isTcp(svc) ? ' (TCP)' : '';
                        h += `<div class="card" style="padding-bottom:14px"><div class="card-title">${svc.last_check ? new Date(svc.last_check).toLocaleString() : ''}</div>`;
                        h += `<div class="inc-box ${boxCls}"><div class="inc-h">${severity === 'critical' ? 'Critical Outage' : 'Major Degradation'}: ${esc(svc.name)}${typeBadge(svc)}</div>`;
                        h += `<div class="inc-affected"><strong>Affected:</strong> ${esc(svc.name)}${tcpLabel}</div>`;
                        h += `<div class="inc-detail"><span>${timeAgo(svc.last_check)}</span><span>${esc(svc.message)}</span></div>`;
                        h += `<div style="margin-top:6px"><span class="inc-badge ${svc.status === 'down' ? 'down' : 'degraded'}">Status: ${svc.status === 'down' ? 'Investigating' : 'Monitoring'}</span></div>`;
                        h += `<div class="inc-spark" id="inc-chart-${i}"></div>`;
                        h += `</div></div>`;
                    })
                } else {
                    h += `<div class="card"><div class="card-title">No Active Incidents</div><div style="text-align:center;padding:40px 0;color:var(--text3)"><p style="font-size:14px">✅ All systems are operating normally</p></div></div>`;
                }
                h += `</div>`;

                // Right column: more incidents or resolved
                h += `<div>`;
                const changedSvcs = svcs.filter(s => s.prev_status && s.prev_status !== 'unknown' && s.prev_status !== s.status);
                if (changedSvcs.length > 0) {
                    changedSvcs.forEach((svc, j) => {
                        const isResolved = svc.status === 'up';
                        h += `<div class="card"><div class="card-title">${svc.last_check ? new Date(svc.last_check).toLocaleString() : ''}</div>`;
                        h += `<div class="inc-box ${isResolved ? 'resolved' : 'minor'}"><div class="inc-h">${isResolved ? 'Resolved' : 'Status Change'}: ${esc(svc.name)}${typeBadge(svc)}</div>`;
                        h += `<div class="inc-affected"><strong>Change:</strong> ${svc.prev_status} → ${svc.status}</div>`;
                        h += `<div class="inc-detail"><span>${timeAgo(svc.last_check)}</span><span>${esc(svc.message)}</span></div>`;
                        h += `<div style="margin-top:6px"><span class="inc-badge ${isResolved ? 'resolved' : 'investigating'}">${isResolved ? 'Resolved' : 'Updated'}</span></div>`;
                        h += `<div class="inc-spark" id="change-chart-${j}"></div>`;
                        h += `</div></div>`;
                    })
                } else {
                    h += `<div class="card"><div class="card-title">Status Changes</div><div style="text-align:center;padding:40px 0;color:var(--text3)"><p style="font-size:14px">No recent status changes detected</p></div></div>`;
                }
                h += `</div></div>`; // end grid-2

                app.innerHTML = h;

                // ApexCharts rendering
                if (typeof ApexCharts !== 'undefined') {
                    if (window.incidentsCharts) { window.incidentsCharts.forEach(function(c) { try { c.destroy(); } catch(e) {} }); window.incidentsCharts = []; }
                    var list = [];

                    // Status radialbars
                    var radialEl = document.getElementById('chart-incidents-status-radial');
                    if (radialEl) {
                        var radialOpts = {
                            series: [upPct, degPct, downPct, unkPct],
                            chart: { type: 'radialBar', height: 260, background: 'transparent' },
                            plotOptions: { radialBar: { dataLabels: { name: { fontSize: '11px' }, value: { fontSize: '13px' }, total: { show: true, label: 'Total', formatter: function() { return total + ' services'; } } } } },
                            labels: ['Up', 'Degraded', 'Down', 'Unknown'],
                            colors: ['#2ecc71', '#f1c40f', '#e74c3c', '#5c6a82'],
                            theme: { mode: 'dark' }
                        };
                        var c1 = new ApexCharts(radialEl, radialOpts);
                        c1.render();
                        list.push(c1);
                    }

                    // Recent Incidents semi-donut
                    var semiEl = document.getElementById('chart-incidents-semi-donut');
                    if (semiEl) {
                        var totalIncidents = down.length + degraded.length + unknown.length;
                        var semiOpts = {
                            series: [down.length, degraded.length, unknown.length],
                            chart: { type: 'donut', height: 240, background: 'transparent' },
                            labels: ['Critical', 'Major', 'Minor'],
                            colors: ['#e74c3c', '#f1c40f', '#25aff4'],
                            legend: { show: false },
                            dataLabels: { enabled: false },
                            plotOptions: {
                                pie: {
                                    startAngle: -90,
                                    endAngle: 90,
                                    offsetY: 10,
                                    donut: {
                                        size: '75%',
                                        labels: {
                                            show: true,
                                            name: { show: true, offsetY: -10, fontSize: '13px', color: '#8c98a4' },
                                            value: { show: true, offsetY: -2, fontSize: '28px', fontWeight: 700, color: '#e2e8f0',
                                                formatter: function(val) { return val; }
                                            },
                                            total: {
                                                show: true,
                                                label: 'Incidents',
                                                fontSize: '13px',
                                                color: '#8c98a4',
                                                formatter: function() { return totalIncidents; }
                                            }
                                        }
                                    }
                                }
                            },
                            grid: { padding: { bottom: -80 } },
                            responsive: [{ breakpoint: 480, options: { chart: { height: 200 } } }],
                            stroke: { width: 0 },
                            tooltip: {
                                enabled: true,
                                theme: 'dark',
                                y: { formatter: function(val) { return val + ' incidents'; } }
                            },
                            states: {
                                hover: { filter: { type: 'lighten', value: 0.15 } },
                                active: { filter: { type: 'none' } }
                            },
                            theme: { mode: 'dark' }
                        };
                        var c2 = new ApexCharts(semiEl, semiOpts);
                        c2.render();
                        list.push(c2);
                    }

                    // Incident area charts — ApexCharts basic area per incident card
                    incidents.forEach(function(svc, i) {
                        var el = document.getElementById('inc-chart-' + i);
                        if (!el) return;
                        var color = svc.status === 'down' ? '#e74c3c' : '#f1c40f';
                        var seriesData = genChartData(svc.response_time_ms || 200, 20, svc.response_time_ms || i * 37 + 11);
                        var opts = {
                            series: [{ name: 'Response', data: seriesData }],
                            chart: { type: 'area', height: 140, toolbar: { show: false }, zoom: { enabled: false }, background: 'transparent' },
                            colors: [color],
                            dataLabels: { enabled: false },
                            stroke: { curve: 'smooth', width: 2 },
                            fill: {
                                type: 'gradient',
                                gradient: { shadeIntensity: 1, opacityFrom: 0.45, opacityTo: 0.05, stops: [0, 90, 100] }
                            },
                            xaxis: { type: 'datetime', labels: { show: false }, axisBorder: { show: false }, axisTicks: { show: false } },
                            yaxis: { labels: { style: { colors: '#5c6a82', fontSize: '10px' }, formatter: function(v) { return Math.round(v) + 'ms' } } },
                            grid: { borderColor: '#1e2d44', strokeDashArray: 3, padding: { left: 4, right: 4 } },
                            tooltip: { theme: 'dark', x: { format: 'HH:mm' }, y: { formatter: function(v) { return Math.round(v) + ' ms' } } },
                            theme: { mode: 'dark' }
                        };
                        var ch = new ApexCharts(el, opts);
                        ch.render();
                        list.push(ch);
                    });

                    // Status change area charts
                    changedSvcs.forEach(function(svc, j) {
                        var el = document.getElementById('change-chart-' + j);
                        if (!el) return;
                        var isResolved = svc.status === 'up';
                        var color = isResolved ? '#2ecc71' : '#25aff4';
                        var seriesData = genChartData(svc.response_time_ms || 150, 20, svc.response_time_ms || 42);
                        var opts = {
                            series: [{ name: 'Response', data: seriesData }],
                            chart: { type: 'area', height: 140, toolbar: { show: false }, zoom: { enabled: false }, background: 'transparent' },
                            colors: [color],
                            dataLabels: { enabled: false },
                            stroke: { curve: 'smooth', width: 2 },
                            fill: {
                                type: 'gradient',
                                gradient: { shadeIntensity: 1, opacityFrom: 0.45, opacityTo: 0.05, stops: [0, 90, 100] }
                            },
                            xaxis: { type: 'datetime', labels: { show: false }, axisBorder: { show: false }, axisTicks: { show: false } },
                            yaxis: { labels: { style: { colors: '#5c6a82', fontSize: '10px' }, formatter: function(v) { return Math.round(v) + 'ms' } } },
                            grid: { borderColor: '#1e2d44', strokeDashArray: 3, padding: { left: 4, right: 4 } },
                            tooltip: { theme: 'dark', x: { format: 'HH:mm' }, y: { formatter: function(v) { return Math.round(v) + ' ms' } } },
                            theme: { mode: 'dark' }
                        };
                        var ch = new ApexCharts(el, opts);
                        ch.render();
                        list.push(ch);
                    });

                    window.incidentsCharts = list;
                }
            }

            async function fetchData() { try { const r = await fetch(DATA_URL + '?t=' + Date.now()); if (!r.ok) throw 0; render(await r.json()) } catch (e) { app.innerHTML = '<div class="no-data"><h3>Waiting for Data</h3><p>Push to GitHub & enable Actions to start monitoring.</p><p style="margin-top:10px"><code>./run-check.sh</code></p></div>' } }
            fetchData(); setInterval(fetchData, 300000);
        })();
    </script>
</body>

</html>