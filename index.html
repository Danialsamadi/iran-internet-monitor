<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#0a0e17">
    <title>Iran Internet Monitor</title>
    <meta name="description"
        content="Real-time monitoring of Iran's internet connectivity, censorship & circumvention tools.">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        :root {
            /* Iran Internet Status Dashboard theme */
            --bg: #0a0e17;
            --bg2: #0f1520;
            --bg3: #141c2b;
            --card: #121a29;
            --card2: #16202f;
            --border: #1e2d44;
            --border2: #253650;
            --text: #e8ecf4;
            --text2: #9aa5b8;
            --text3: #5c6a82;
            --green: #2ecc71;
            --green2: #27ae60;
            --green-g: rgba(46, 204, 113, 0.15);
            --yellow: #f1c40f;
            --yellow2: #e67e22;
            --yellow-g: rgba(241, 196, 15, 0.15);
            --red: #e74c3c;
            --red2: #c0392b;
            --red-g: rgba(231, 76, 60, 0.15);
            --accent: #25aff4;
            --accent-g: rgba(37, 175, 244, 0.15);
            --cyan: #25aff4;
            --purple: #7c3aed;
            --blue: #3b82f6;
            --font: 'Inter', system-ui, -apple-system, sans-serif;
            --r: 8px;
            --r2: 8px;
            --touch: 44px;
        }

        body {
            font-family: var(--font);
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased
        }

        /* Aurora bg — accent #25aff4 */
        body::before {
            content: '';
            position: fixed;
            top: -40%;
            left: -20%;
            width: 140%;
            height: 100%;
            background: radial-gradient(ellipse at 30% 20%, rgba(37, 175, 244, 0.07), transparent 60%), radial-gradient(ellipse at 70% 60%, rgba(124, 58, 237, 0.05), transparent 50%), radial-gradient(ellipse at 50% 80%, rgba(231, 76, 60, 0.04), transparent 50%);
            pointer-events: none;
            z-index: 0
        }

        /* Nav */
        .nav {
            background: rgba(15, 21, 32, 0.85);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100
        }

        .nav-inner {
            max-width: 1380px;
            margin: 0 auto;
            padding: 0 28px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 52px
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: var(--text)
        }

        .nav-brand svg {
            width: 26px;
            height: 26px
        }

        .nav-brand span {
            font-size: 14px;
            font-weight: 700;
            letter-spacing: -.3px
        }

        .nav-links {
            display: flex;
            gap: 2px
        }

        .nav-links a {
            color: var(--text2);
            text-decoration: none;
            font-size: 12px;
            font-weight: 500;
            padding: 6px 14px;
            border-radius: 6px;
            transition: .2s
        }

        .nav-links a:hover,
        .nav-links a.active {
            color: var(--text);
            background: var(--card)
        }

        .nav-links a.active {
            border-bottom: 2px solid var(--accent);
            color: var(--accent)
        }

        .nav-ts {
            font-size: 11px;
            color: var(--text3);
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
            line-height: 1.3
        }

        .nav-ts .clock-row {
            display: flex;
            align-items: center;
            gap: 5px
        }

        .nav-ts .clock-label {
            color: var(--text3);
            opacity: .7
        }

        .nav-ts .clock-val {
            color: var(--text2);
            font-variant-numeric: tabular-nums
        }

        /* Layout */
        .wrap {
            max-width: 1380px;
            margin: 0 auto;
            padding: 20px 28px 60px;
            position: relative;
            z-index: 1
        }

        .page-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            letter-spacing: -.3px
        }

        /* Grid */
        .grid {
            display: grid;
            gap: 20px
        }

        .grid-top {
            grid-template-columns: 1fr;
            margin-bottom: 20px
        }

        .grid-svc-overview {
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px
        }

        .grid-mid {
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px
        }

        .grid-bot {
            grid-template-columns: 1fr 1fr 1fr;
            gap: 28px;
            margin-bottom: 20px
        }

        .grid-bot > .card {
            min-width: 0
        }

        /* Card */
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--r2);
            padding: 20px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15)
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(37, 175, 244, 0.2), transparent)
        }

        .card-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text2);
            text-transform: uppercase;
            letter-spacing: .6px;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between
        }

        .card-title .legend {
            display: flex;
            gap: 12px;
            font-size: 10px;
            text-transform: none;
            letter-spacing: 0
        }

        .card-title .legend span {
            display: flex;
            align-items: center;
            gap: 4px
        }

        .card-title .legend .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: inline-block
        }

        /* Gauge */
        .gauge-wrap {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 0
        }

        .gauge-outer {
            position: relative;
            width: 200px;
            height: 200px
        }

        .gauge-svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg)
        }

        .gauge-bg {
            fill: none;
            stroke: var(--border);
            stroke-width: 10
        }

        .gauge-fill {
            fill: none;
            stroke-width: 10;
            stroke-linecap: round;
            transition: stroke-dashoffset 1.5s ease
        }

        .gauge-center {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center
        }

        .gauge-pct {
            font-size: 42px;
            font-weight: 800;
            letter-spacing: -2px;
            background: linear-gradient(135deg, var(--green), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent
        }

        .gauge-label {
            font-size: 11px;
            color: var(--text3);
            margin-top: 2px
        }

        /* SVG Charts */
        .chart-container {
            width: 100%;
            height: 120px;
            position: relative
        }

        .chart-container svg {
            width: 100%;
            height: 100%
        }

        .area-fill {
            opacity: .2
        }

        .area-line {
            fill: none;
            stroke-width: 1.5;
            stroke-linecap: round;
            stroke-linejoin: round
        }

        /* Service table cards: more breathing room */
        .card:has(.svc-table-outer) {
            padding-top: 24px;
            padding-bottom: 24px
        }

        /* Service table: header outside scroll so it never hides */
        .svc-table-outer {
            border-radius: var(--r);
            background: var(--border);
            overflow: hidden;
            margin-top: 12px;
            margin-bottom: 4px
        }

        .svc-table-outer .svc-row.header {
            border-radius: var(--r) var(--r) 0 0;
            box-shadow: 0 1px 0 var(--border)
        }

        .svc-grid {
            display: grid;
            gap: 1px;
            background: var(--border)
        }

        .svc-grid-wrap {
            max-height: 320px;
            overflow-y: auto;
            overflow-x: hidden;
            border-radius: 0 0 var(--r) var(--r);
            scrollbar-gutter: stable;
            padding-bottom: 12px
        }

        .svc-cat-header {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: .5px;
            color: var(--text3);
            background: var(--bg2);
            border-bottom: 1px solid var(--border)
        }

        .svc-cat-header:first-of-type { margin-top: 0 }

        .svc-spark {
            width: 52px;
            min-width: 52px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px
        }

        .svc-spark .apexcharts-canvas { margin: 0 auto }

        .svc-row {
            display: grid;
            grid-template-columns: 1fr 52px 72px 80px 80px;
            align-items: center;
            padding: 9px 14px;
            background: var(--card);
            font-size: 12px;
            transition: .15s
        }

        .svc-row:hover {
            background: var(--card2)
        }

        .svc-row.header {
            background: var(--bg3);
            font-weight: 600;
            color: var(--text2);
            text-transform: uppercase;
            letter-spacing: .4px;
            font-size: 10px
        }

        .svc-name {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 0
        }

        .svc-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            flex-shrink: 0
        }

        .svc-dot.up {
            background: var(--green);
            box-shadow: 0 0 6px var(--green)
        }

        .svc-dot.down {
            background: var(--red);
            box-shadow: 0 0 6px var(--red)
        }

        .svc-dot.degraded {
            background: var(--yellow);
            box-shadow: 0 0 6px var(--yellow)
        }

        .svc-dot.unknown {
            background: var(--text3)
        }

        .svc-type-badge {
            font-size: 9px;
            font-weight: 600;
            padding: 1px 5px;
            border-radius: 3px;
            text-transform: uppercase;
            letter-spacing: .3px;
            flex-shrink: 0
        }

        .svc-type-badge.tcp {
            background: rgba(124, 58, 237, 0.15);
            color: var(--purple)
        }

        .svc-type-badge.http {
            background: rgba(37, 175, 244, 0.1);
            color: var(--cyan)
        }

        .svc-label {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap
        }

        .svc-val {
            text-align: right;
            font-variant-numeric: tabular-nums
        }

        .svc-up {
            color: var(--green)
        }

        .svc-deg {
            color: var(--yellow)
        }

        .svc-down {
            color: var(--red)
        }

        /* Sparkline row */
        .spark-row {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border)
        }

        .spark-row:last-child {
            border: none
        }

        .spark-name {
            font-size: 12px;
            font-weight: 500;
            width: 140px;
            flex-shrink: 0
        }

        .spark-val {
            font-size: 11px;
            color: var(--text2);
            width: 60px;
            text-align: right;
            flex-shrink: 0;
            font-variant-numeric: tabular-nums
        }

        .spark-chart {
            flex: 1;
            height: 28px
        }

        .spark-chart svg {
            width: 100%;
            height: 100%
        }

        /* Incidents */
        .inc-card {
            background: var(--card2);
            border: 1px solid var(--border);
            border-left: 3px solid var(--red);
            border-radius: var(--r);
            padding: 14px 16px;
            margin-bottom: 10px
        }

        .inc-card.degraded {
            border-left-color: var(--yellow)
        }

        .inc-card.resolved {
            border-left-color: var(--green)
        }

        .inc-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px
        }

        .inc-meta {
            font-size: 11px;
            color: var(--text3);
            display: flex;
            gap: 12px;
            flex-wrap: wrap
        }

        .inc-status {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 4px;
            display: inline-block;
            margin-top: 6px
        }

        .inc-status.down {
            background: var(--red-g);
            color: var(--red)
        }

        .inc-status.degraded {
            background: var(--yellow-g);
            color: var(--yellow)
        }

        .inc-status.resolved {
            background: var(--green-g);
            color: var(--green)
        }

        /* Heatmap */
        .heatmap {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px
        }

        .heat-cell {
            aspect-ratio: 1;
            border-radius: 3px;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text3);
            cursor: default;
            transition: .15s
        }

        .heat-cell:hover {
            transform: scale(1.2);
            z-index: 2
        }

        .heat-up {
            background: var(--green);
            opacity: .7
        }

        .heat-deg {
            background: var(--yellow);
            opacity: .7
        }

        .heat-down {
            background: var(--red);
            opacity: .7
        }

        .heat-none {
            background: var(--border)
        }

        .heat-label {
            font-size: 9px;
            color: var(--text3);
            text-align: center;
            padding: 2px 0
        }

        /* Graph filters */
        .graph-filters {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 14px 18px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--r2)
        }

        .graph-filters label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text2);
            text-transform: uppercase;
            letter-spacing: .4px;
            display: flex;
            align-items: center;
            gap: 8px
        }

        .graph-filters select {
            background: var(--bg3);
            border: 1px solid var(--border);
            color: var(--text);
            font-family: var(--font);
            font-size: 12px;
            padding: 8px 12px;
            border-radius: var(--r);
            cursor: pointer;
            min-width: 140px
        }

        .graph-filters select:focus {
            outline: none;
            border-color: var(--accent)
        }

        .graph-filters .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap
        }

        .graph-filters .chip {
            font-size: 11px;
            font-weight: 500;
            padding: 6px 12px;
            border-radius: 20px;
            background: var(--bg3);
            border: 1px solid var(--border);
            color: var(--text2);
            cursor: pointer;
            transition: .2s
        }

        .graph-filters .chip:hover,
        .graph-filters .chip.active {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-g)
        }

        /* Chart card with axes */
        .chart-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--r2);
            padding: 20px;
            position: relative;
            overflow: hidden;
            margin-bottom: 20px
        }

        .chart-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(37, 175, 244, 0.2), transparent)
        }

        .chart-card .card-title {
            margin-bottom: 16px
        }

        .chart-area-wrap {
            position: relative;
            width: 100%;
            height: 220px;
            margin: 8px 0 24px
        }

        .chart-area-wrap {
            cursor: crosshair
        }

        .chart-area-wrap svg {
            width: 100%;
            height: 100%;
            display: block
        }

        .chart-svg {
            overflow: visible
        }

        .chart-grid line {
            stroke: var(--border);
            stroke-dasharray: 2 4;
            opacity: .6
        }

        .chart-axis {
            fill: var(--text3);
            font-size: 10px;
            font-variant-numeric: tabular-nums
        }

        .chart-tooltip {
            position: fixed;
            background: var(--bg3);
            border: 1px solid var(--border2);
            border-radius: var(--r);
            padding: 8px 12px;
            font-size: 11px;
            color: var(--text);
            pointer-events: none;
            z-index: 200;
            box-shadow: 0 4px 20px rgba(0,0,0,.4);
            opacity: 0;
            transition: opacity .15s
        }

        .chart-tooltip.visible {
            opacity: 1
        }

        .chart-tooltip strong {
            color: var(--accent)
        }

        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px 20px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border)
        }

        .chart-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text2);
            cursor: pointer;
            user-select: none;
            padding: 4px 8px;
            border-radius: 6px;
            transition: .2s
        }

        .chart-legend-item:hover {
            background: var(--card2);
            color: var(--text)
        }

        .chart-legend-item.hidden {
            opacity: .4;
            text-decoration: line-through
        }

        .chart-legend-item .leg-dot {
            width: 10px;
            height: 10px;
            border-radius: 2px;
            flex-shrink: 0
        }

        .multi-spark-wrap {
            display: flex;
            flex-direction: column;
            gap: 0
        }

        .multi-spark-row {
            display: grid;
            grid-template-columns: 1fr 1fr 80px;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
            transition: .15s
        }

        .multi-spark-row:last-child {
            border-bottom: none
        }

        .multi-spark-row.hidden {
            display: none
        }

        .multi-spark-row:hover {
            background: var(--card2)
        }

        .multi-spark-row .spark-name {
            width: auto;
            min-width: 0
        }

        .multi-spark-row .spark-chart {
            height: 36px;
            min-width: 120px
        }

        .apex-spark-wrap {
            height: 36px;
            min-width: 120px
        }

        /* Compare response time — up to 4 services, line/area chart */
        .compare-svc-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px 16px;
            margin-bottom: 16px
        }
        .compare-svc-row label {
            font-size: 11px;
            color: var(--text2);
            text-transform: uppercase;
            letter-spacing: .4px
        }
        .compare-svc-row select {
            min-width: 140px;
            padding: 6px 10px;
            border-radius: var(--r);
            border: 1px solid var(--border);
            background: var(--bg2);
            color: var(--text);
            font-size: 12px
        }
        #chart-compare-response {
            min-height: 260px;
            margin-top: 8px
        }

        @media (max-width: 600px) {
            .graph-filters { flex-direction: column; align-items: stretch }
            .graph-filters select { min-width: 100% }
            .chart-area-wrap { height: 180px }
            .multi-spark-row { grid-template-columns: 1fr 70px }
            .multi-spark-row .spark-chart { min-width: 80px }
        }

        /* Single donut — proportions (avoid pie with many slices) */
        .donut-single-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px
        }

        .donut-single-wrap .donut-single {
            width: 140px;
            height: 140px
        }

        .donut-legend-inline {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 6px 14px;
            font-size: 11px;
            color: var(--text2)
        }

        .donut-legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 2px;
            display: inline-block
        }

        .cat-list { padding: 0 }
        .cat-row {
            display: grid;
            grid-template-columns: 10px 1fr auto auto;
            align-items: center;
            gap: 10px 12px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            font-size: 13px
        }
        .cat-row:last-child { border-bottom: none }
        .cat-pct-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0
        }
        .cat-name { font-weight: 500; color: var(--text); min-width: 0; overflow: hidden; text-overflow: ellipsis }
        .cat-meta { font-size: 11px; color: var(--text3) }
        .cat-pct { font-size: 12px; font-weight: 600; min-width: 2.2em; text-align: right }

        .uptime-cat-list { padding: 4px 0 }
        .uptime-cat-row {
            display: grid;
            grid-template-columns: 1fr 120px 72px;
            align-items: center;
            gap: 10px 12px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 12px
        }
        .uptime-cat-row:last-child { border-bottom: none }
        .uptime-cat-label {
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text);
            font-weight: 500
        }
        .uptime-cat-bar-wrap {
            height: 10px;
            background: var(--bg3);
            border-radius: 2px;
            overflow: hidden
        }
        .uptime-cat-bar { height: 100%; border-radius: 2px; min-width: 2px; transition: width .2s }
        .uptime-cat-values {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 8px;
            font-size: 11px
        }
        .uptime-cat-frac { color: var(--text3) }
        .uptime-cat-pct { font-weight: 600; min-width: 2.2em; text-align: right }

        .bar-chart-wrap {
            width: 100%;
            min-height: 160px
        }

        .bar-chart-wrap svg {
            width: 100%;
            height: auto;
            display: block
        }

        .apex-chart-wrap {
            min-height: 220px;
            margin: 8px 0 16px
        }

        .apex-radial-wrap {
            min-height: 280px;
            margin: 8px 0
        }

        /* No-data */
        .no-data {
            text-align: center;
            padding: 80px 20px;
            color: var(--text3)
        }

        .no-data h3 {
            font-size: 18px;
            color: var(--text2);
            margin-bottom: 8px
        }

        .no-data code {
            background: var(--card);
            padding: 4px 10px;
            border-radius: var(--r);
            font-size: 12px;
            color: var(--accent)
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 100px 0;
            color: var(--text3)
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin .7s linear infinite;
            margin: 0 auto 12px
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        /* Footer */
        .footer {
            border-top: 1px solid var(--border);
            padding: 24px;
            text-align: center;
            font-size: 11px;
            color: var(--text3);
            margin-top: 40px
        }

        .footer a {
            color: var(--text2);
            text-decoration: none
        }

        .footer a:hover {
            color: var(--text)
        }

        /* Mobile: hamburger + touch targets */
        .nav-toggle {
            display: none;
            width: var(--touch);
            height: var(--touch);
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: var(--text);
            cursor: pointer;
            border-radius: var(--r);
            -webkit-tap-highlight-color: transparent
        }

        .nav-toggle:focus-visible {
            outline: 2px solid var(--accent)
        }

        .nav-toggle span {
            display: block;
            width: 20px;
            height: 2px;
            background: currentColor;
            border-radius: 1px;
            margin: 6px 0;
            transition: .2s
        }

        .nav-toggle span::before,
        .nav-toggle span::after {
            content: '';
            display: block;
            width: 20px;
            height: 2px;
            background: currentColor;
            border-radius: 1px;
            transition: .2s
        }

        .nav.open .nav-toggle span { background: transparent }
        .nav.open .nav-toggle span::before { transform: translateY(8px) rotate(45deg) }
        .nav.open .nav-toggle span::after { transform: translateY(-8px) rotate(-45deg) }

        @media (max-width: 900px) {
            .grid-top, .grid-mid, .grid-svc-overview { grid-template-columns: 1fr }
            .grid-bot { grid-template-columns: 1fr }
            .uptime-cat-row { grid-template-columns: 1fr 80px 64px }
        }

        @media (max-width: 768px) {
            .nav-inner {
                padding: 0 16px;
                min-height: var(--touch)
            }

            .nav-toggle { display: flex }

            .nav-links {
                position: fixed;
                top: 52px;
                left: 0;
                right: 0;
                background: var(--bg2);
                border-bottom: 1px solid var(--border);
                flex-direction: column;
                padding: 12px;
                gap: 4px;
                transform: translateY(-100%);
                opacity: 0;
                visibility: hidden;
                transition: transform .2s, opacity .2s, visibility .2s;
                z-index: 99;
                box-shadow: 0 8px 24px rgba(0,0,0,.3)
            }

            .nav.open .nav-links {
                transform: translateY(0);
                opacity: 1;
                visibility: visible
            }

            .nav-links a {
                padding: 12px 16px;
                min-height: var(--touch);
                display: flex;
                align-items: center;
                border-radius: var(--r)
            }

            .nav-ts { display: none }
        }

        @media (max-width: 600px) {
            .wrap {
                padding: 16px 16px 48px;
                padding-left: max(16px, env(safe-area-inset-left));
                padding-right: max(16px, env(safe-area-inset-right));
                padding-bottom: max(48px, env(safe-area-inset-bottom))
            }

            .page-title { font-size: 18px; margin-bottom: 16px }

            .svc-row {
                grid-template-columns: 1fr 44px 56px 70px 60px;
                padding: 12px 10px;
                font-size: 11px
            }
            .svc-spark { width: 44px; min-width: 44px; height: 24px }

            .gauge-outer { width: 160px; height: 160px }
            .gauge-pct { font-size: 32px }
            .card { padding: 16px }
            .heat-cell { font-size: 7px }
        }
    </style>
</head>

<body>
    <nav class="nav" id="nav">
        <div class="nav-inner">
            <a href="index.html" class="nav-brand" aria-label="Home"><svg viewBox="0 0 40 40" fill="none" aria-hidden="true">
                    <circle cx="20" cy="20" r="18" fill="var(--accent)" opacity=".15" />
                    <path d="M20 8L28 20l-4 0v12H16V20l-4 0z" fill="var(--accent)" />
                </svg><span>Iran Internet Status</span></a>
            <button type="button" class="nav-toggle" aria-label="Open menu" aria-expanded="false"><span></span></button>
            <div class="nav-links">
                <a href="index.html" class="active">Dashboard</a>
                <a href="monitors.html">Monitors</a>
                <a href="incidents.html">Incidents</a>
                <a href="https://github.com/Danialsamadi/iran-internet-monitor" target="_blank" rel="noopener">GitHub</a>
            </div>
            <div class="nav-ts" id="nav-clock">
                <div class="clock-row"><span class="clock-label">Iran</span><span class="clock-val" id="clock-iran">--:--:--</span></div>
                <div class="clock-row"><span class="clock-label">Local</span><span class="clock-val" id="clock-local">--:--:--</span></div>
            </div>
        </div>
    </nav>
    <script>document.getElementById('nav').addEventListener('click', function(e) {
        if (e.target.closest('.nav-toggle')) {
            this.classList.toggle('open');
            this.querySelector('.nav-toggle').setAttribute('aria-expanded', this.classList.contains('open'));
        }
    });
    (function() {
        function pad(n) { return n < 10 ? '0' + n : n; }
        function tick() {
            var now = new Date();
            var iranEl = document.getElementById('clock-iran');
            var localEl = document.getElementById('clock-local');
            if (iranEl) {
                var iran = now.toLocaleString('en-GB', { timeZone: 'Asia/Tehran', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
                var iranDate = now.toLocaleString('en-GB', { timeZone: 'Asia/Tehran', day: '2-digit', month: 'short' });
                iranEl.textContent = iranDate + ' ' + iran;
            }
            if (localEl) {
                localEl.textContent = pad(now.getDate()) + ' ' + now.toLocaleString('en-GB', { month: 'short' }) + ' ' + pad(now.getHours()) + ':' + pad(now.getMinutes()) + ':' + pad(now.getSeconds());
            }
        }
        tick();
        setInterval(tick, 1000);
    })();</script>

    <div class="wrap">
        <h1 class="page-title">Internet Health Monitor — Iran</h1>
        <div id="chart-tooltip" class="chart-tooltip" aria-hidden="true"></div>
        <div id="app">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading status data…</p>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>Powered by <a href="https://github.com/Danialsamadi/iran-internet-monitor">Iran Internet Monitor</a> · Data
            from <a href="https://ioda.inetintel.cc.gatech.edu/">IODA</a> · <a href="https://ooni.org/">OONI</a> · <a
                href="https://atlas.ripe.net/">RIPE</a> · <a href="https://metrics.torproject.org/">Tor</a> · <a
                href="https://psiphon.ca/">Psiphon</a></p>
    </div>

    <script>
        (function () {
            'use strict';
            const DATA_URL = 'api/page-data.json', REFRESH = 300000, app = document.getElementById('app');

            function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML }
            function timeAgo(iso) { if (!iso) return ''; const s = Math.floor((Date.now() - new Date(iso)) / 1e3); if (s < 60) return 'just now'; if (s < 3600) return Math.floor(s / 60) + 'm ago'; if (s < 86400) return Math.floor(s / 3600) + 'h ago'; return Math.floor(s / 86400) + 'd ago' }

            // SVG helpers
            function makeArea(w, h, values, color) {
                if (!values.length) return '';
                const mx = Math.max(...values) * 1.25 || 1, n = values.length, xS = w / (n - 1);
                let lp = '', ap = '';
                values.forEach((v, i) => { const x = i * xS, y = h - ((v / mx) * h * 0.85 + h * 0.05); lp += (i ? 'L' : 'M') + x.toFixed(1) + ',' + y.toFixed(1) });
                ap = lp + ` L${w},${h} L0,${h} Z`;
                return `<svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none"><path class="area-fill" d="${ap}" fill="${color}" /><path class="area-line" d="${lp}" stroke="${color}"/></svg>`
            }

            function makeSparkline(w, h, values, color) {
                if (!values.length) values = [0];
                const mx = Math.max(...values) * 1.2 || 1, n = values.length, xS = w / Math.max(n - 1, 1);
                let p = ''; values.forEach((v, i) => { const x = i * xS, y = h - ((v / mx) * h * 0.8 + h * 0.1); p += (i ? 'L' : 'M') + x.toFixed(1) + ',' + y.toFixed(1) });
                return `<svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none"><path d="${p}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`
            }

            function gaugeColor(pct) { return pct >= 95 ? 'var(--green)' : pct >= 80 ? 'var(--yellow)' : 'var(--red)' }

            function makeGauge(pct) {
                const r = 85, circ = 2 * Math.PI * r, offset = circ * (1 - pct / 100), color = gaugeColor(pct);
                return `<div class="gauge-wrap"><div class="gauge-outer"><svg class="gauge-svg" viewBox="0 0 200 200"><circle class="gauge-bg" cx="100" cy="100" r="${r}"/><circle class="gauge-fill" cx="100" cy="100" r="${r}" stroke="${color}" stroke-dasharray="${circ}" stroke-dashoffset="${offset}"/></svg><div class="gauge-center"><div class="gauge-pct">${pct.toFixed(1)}%</div><div class="gauge-label">Overall Uptime</div></div></div></div>`
            }

            function genFakeHistory(rt, n) {
                let seed = rt || 100; function rnd() { seed = (seed * 16807 + 7) % 2147483647; return (seed % 1000) / 1000 }
                const a = []; for (let i = 0; i < n; i++)a.push(rt * (0.3 + rnd() * 0.7)); a[n - 1] = rt; return a
            }

            function isTcp(svc) { return svc && (svc.check_type === 'tcp' || (svc.id && svc.id.startsWith('ir-tcp-'))) }
            function typeBadge(svc) { return isTcp(svc) ? '<span class="svc-type-badge tcp">TCP</span>' : '<span class="svc-type-badge http">HTTP</span>' }
            function checkLabel(svc) { if (isTcp(svc)) { return svc.http_code === 1 ? 'Connected' : 'Failed' } return svc.http_code ? 'HTTP ' + svc.http_code : '—' }

            const COLORS = { up: '#2ecc71', degraded: '#f1c40f', down: '#e74c3c', unknown: '#5c6a82' };
            /* Limited palette for line charts — avoid too many colors */
            const SERIES_COLORS = ['#25aff4', '#2ecc71', '#f1c40f', '#e74c3c', '#5c6a82'];

            function getFilteredServices(data, filter) {
                if (!data || !data.services) return [];
                let list = data.services.slice();
                if (filter.category && filter.category !== 'all') {
                    const cats = data.categories || [];
                    const idx = parseInt(filter.category, 10);
                    if (!isNaN(idx) && cats[idx]) {
                        const ids = cats[idx].service_ids || [];
                        list = list.filter(s => ids.includes(s.id));
                    }
                }
                if (filter.status && filter.status !== 'all') list = list.filter(s => (s.status || '') === filter.status);
                return list;
            }

            function parseHistoryCsv(txt) {
                const rows = [];
                txt.split(/\n/).forEach(line => {
                    const parts = line.trim().split(',');
                    if (parts.length >= 4) rows.push({ ts: parts[0], status: parts[1], value: parseFloat(parts[2]) || 0, rt: parseInt(parts[3], 10) || 0 });
                });
                return rows;
            }

            function buildUptimeFromHistory(rows, days) {
                if (!rows.length) return null;
                const byDay = {};
                rows.forEach(r => {
                    const d = r.ts.slice(0, 10);
                    if (!byDay[d]) byDay[d] = { up: 0, total: 0 };
                    byDay[d].total++;
                    if (r.status === 'up') byDay[d].up++;
                });
                const sorted = Object.keys(byDay).sort();
                const start = sorted[0];
                const out = [];
                for (let i = 0; i < days; i++) {
                    const d = new Date();
                    d.setDate(d.getDate() - (days - 1 - i));
                    const key = d.toISOString().slice(0, 10);
                    const v = byDay[key];
                    out.push(v ? (v.up / v.total * 100) : null);
                }
                return out;
            }

            function buildResponseFromHistory(rows, points) {
                if (!rows.length) return null;
                const len = Math.min(rows.length, points);
                const step = Math.max(1, Math.floor(rows.length / len));
                const out = [];
                for (let i = 0; i < len; i++) {
                    const r = rows[rows.length - 1 - i * step];
                    if (r) out.push(r.rt || 0);
                }
                return out.reverse();
            }

            function makeAreaChartWithGrid(w, h, values, color, opts) {
                opts = opts || {};
                const pad = { left: opts.yAxis ? 36 : 8, right: 8, top: 8, bottom: opts.xAxis ? 20 : 8 };
                const innerW = w - pad.left - pad.right, innerH = h - pad.top - pad.bottom;
                if (!values.length) return '';
                const clean = values.map(v => v == null ? 0 : v);
                const mx = Math.max(...clean) * 1.1 || 100;
                const n = clean.length;
                const xS = innerW / Math.max(n - 1, 1);
                let path = '', areaPath = '';
                clean.forEach((v, i) => {
                    const x = pad.left + i * xS;
                    const y = pad.top + innerH - (v / mx) * innerH * 0.9;
                    path += (i ? 'L' : 'M') + x.toFixed(1) + ',' + y.toFixed(1);
                    areaPath = path + ` L${pad.left + innerW},${pad.top + innerH} L${pad.left},${pad.top + innerH} Z`;
                });
                let grid = '';
                for (let g = 1; g < 4; g++) {
                    const gy = pad.top + (innerH / 4) * g;
                    grid += `<line x1="${pad.left}" y1="${gy}" x2="${pad.left + innerW}" y2="${gy}" class="chart-grid"/>`;
                }
                for (let g = 1; g < 5; g++) {
                    const gx = pad.left + (innerW / 5) * g;
                    grid += `<line x1="${gx}" y1="${pad.top}" x2="${gx}" y2="${pad.top + innerH}" class="chart-grid"/>`;
                }
                let axes = '';
                if (opts.yAxis) {
                    axes += `<text x="${pad.left - 4}" y="${pad.top + 10}" class="chart-axis" text-anchor="end">${Math.round(mx)}%</text>`;
                    axes += `<text x="${pad.left - 4}" y="${pad.top + innerH + 4}" class="chart-axis" text-anchor="end">0%</text>`;
                }
                if (opts.xAxis && opts.labels) {
                    opts.labels.forEach((lbl, i) => {
                        const x = pad.left + (innerW * (i / (opts.labels.length - 1)));
                        axes += `<text x="${x}" y="${h - 4}" class="chart-axis" text-anchor="middle">${lbl}</text>`;
                    });
                }
                /* Line chart: trend over time — minimal fill so data is not obscured */
                return `<svg viewBox="0 0 ${w} ${h}" class="chart-svg"><g>${grid}</g><path class="area-fill" d="${areaPath}" fill="${color}" opacity=".06"/><path d="${path}" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><g>${axes}</g></svg>`;
            }

            function makeLineChartOnly(w, h, values, color, opts) {
                opts = opts || {};
                const pad = { left: opts.yAxis ? 36 : 8, right: 8, top: 8, bottom: opts.xAxis ? 20 : 8 };
                const innerW = w - pad.left - pad.right, innerH = h - pad.top - pad.bottom;
                if (!values.length) return '';
                const clean = values.map(v => v == null ? 0 : v);
                const mx = Math.max(...clean) * 1.1 || 100;
                const n = clean.length;
                const xS = innerW / Math.max(n - 1, 1);
                let path = '';
                clean.forEach((v, i) => {
                    const x = pad.left + i * xS;
                    const y = pad.top + innerH - (v / mx) * innerH * 0.9;
                    path += (i ? 'L' : 'M') + x.toFixed(1) + ',' + y.toFixed(1);
                });
                let grid = '';
                for (let g = 1; g < 4; g++) {
                    const gy = pad.top + (innerH / 4) * g;
                    grid += `<line x1="${pad.left}" y1="${gy}" x2="${pad.left + innerW}" y2="${gy}" class="chart-grid"/>`;
                }
                for (let g = 1; g < 5; g++) {
                    const gx = pad.left + (innerW / 5) * g;
                    grid += `<line x1="${gx}" y1="${pad.top}" x2="${gx}" y2="${pad.top + innerH}" class="chart-grid"/>`;
                }
                let axes = '';
                if (opts.yAxis) {
                    axes += `<text x="${pad.left - 4}" y="${pad.top + 10}" class="chart-axis" text-anchor="end">${Math.round(mx)}%</text>`;
                    axes += `<text x="${pad.left - 4}" y="${pad.top + innerH + 4}" class="chart-axis" text-anchor="end">0%</text>`;
                }
                if (opts.xAxis && opts.labels) {
                    opts.labels.forEach((lbl, i) => {
                        const x = pad.left + (innerW * (i / (opts.labels.length - 1)));
                        axes += `<text x="${x}" y="${h - 4}" class="chart-axis" text-anchor="middle">${lbl}</text>`;
                    });
                }
                return `<svg viewBox="0 0 ${w} ${h}" class="chart-svg"><g>${grid}</g><path d="${path}" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><g>${axes}</g></svg>`;
            }

            function makeBarChart(w, h, bars, pad) {
                pad = pad || { left: 100, right: 44, top: 16, bottom: 24 };
                const innerW = w - pad.left - pad.right, innerH = h - pad.top - pad.bottom;
                if (!bars.length) return '<svg viewBox="0 0 ' + w + ' ' + h + '" class="chart-svg"></svg>';
                const maxVal = Math.max(...bars.map(b => b.value), 1);
                const gap = 6;
                const barH = Math.max(14, (innerH - (bars.length - 1) * gap) / bars.length);
                let out = '';
                bars.forEach(function(b, i) {
                    const y = pad.top + i * (barH + gap);
                    const barW = (b.value / maxVal) * innerW * 0.88;
                    out += '<rect x="' + pad.left + '" y="' + y + '" width="' + barW + '" height="' + barH + '" rx="2" fill="' + b.color + '" opacity=".92"/>';
                    out += '<text x="' + (pad.left - 6) + '" y="' + (y + barH / 2 + 4) + '" class="chart-axis" text-anchor="end">' + esc(b.label) + '</text>';
                    out += '<text x="' + (pad.left + barW + 6) + '" y="' + (y + barH / 2 + 4) + '" class="chart-axis" text-anchor="start">' + b.value + '%</text>';
                });
                return '<svg viewBox="0 0 ' + w + ' ' + h + '" class="chart-svg"><line x1="' + pad.left + '" y1="' + pad.top + '" x2="' + pad.left + '" y2="' + (pad.top + innerH) + '" stroke="var(--border)" stroke-width="1"/><g>' + out + '</g><text x="' + (pad.left - 4) + '" y="' + (pad.top + 10) + '" class="chart-axis" text-anchor="end">' + Math.round(maxVal) + '%</text></svg>';
            }

            function makeMultiLinePath(w, h, series, pad) {
                const innerW = w - pad.left - pad.right, innerH = h - pad.top - pad.bottom;
                const allV = series.reduce((a, s) => a.concat(s.values), []);
                const mx = Math.max(...allV) * 1.15 || 1;
                const n = series[0] ? series[0].values.length : 0;
                const xS = n > 1 ? innerW / (n - 1) : innerW;
                const paths = series.map(s => {
                    let p = '';
                    s.values.forEach((v, i) => {
                        const x = pad.left + i * xS;
                        const y = pad.top + innerH - (v / mx) * innerH * 0.9;
                        p += (i ? 'L' : 'M') + x.toFixed(1) + ',' + y.toFixed(1);
                    });
                    return `<path d="${p}" fill="none" stroke="${s.color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-series="${s.id}"/>`;
                }).join('');
                let grid = '';
                for (let g = 1; g < 4; g++) {
                    const gy = pad.top + (innerH / 4) * g;
                    grid += `<line x1="${pad.left}" y1="${gy}" x2="${pad.left + innerW}" y2="${gy}" class="chart-grid"/>`;
                }
                for (let g = 1; g < 5; g++) {
                    const gx = pad.left + (innerW / 5) * g;
                    grid += `<line x1="${gx}" y1="${pad.top}" x2="${gx}" y2="${pad.top + innerH}" class="chart-grid"/>`;
                }
                const maxVal = Math.round(mx);
                return `<svg viewBox="0 0 ${w} ${h}" class="chart-svg"><g>${grid}</g>${paths}<text x="${pad.left - 4}" y="${pad.top + 10}" class="chart-axis" text-anchor="end">${maxVal}ms</text><text x="${pad.left - 4}" y="${pad.top + innerH + 4}" class="chart-axis" text-anchor="end">0</text></svg>`;
            }

            let filterState = { category: 'all', status: 'all', timeRange: '30', compareSelectedIds: [] };
            let historyCache = {};
            let lastData = null;
            let lastCompareList = [];
            let compareChartRef = null;

            function render(data) {
                if (!data || !data.summary) { app.innerHTML = '<div class="no-data"><h3>Waiting for Data</h3><p>Push to GitHub and enable Actions, or run locally:</p><p style="margin-top:10px"><code>./run-check.sh</code></p></div>'; return }
                try {
                lastData = data;
                const { summary: sm, services: svcs, categories: cats } = data;
                const sMap = {}; (svcs || []).forEach(s => sMap[s.id] = s);
                // clock is handled by the nav tick script

                const filtered = getFilteredServices(data, filterState);
                const uptimes = filtered.filter(s => s.uptime_pct != null).map(s => +s.uptime_pct);
                const overallUp = uptimes.length ? uptimes.reduce((a, b) => a + b, 0) / uptimes.length : (svcs || []).filter(s => s.uptime_pct != null).map(s => +s.uptime_pct).reduce((a, b) => a + b, 0) / Math.max((svcs || []).length, 1);
                const days = parseInt(filterState.timeRange, 10) || 30;
                const numPoints = Math.min(days, 60);

                let h = '';

                // Filter bar
                const catOptions = (cats || []).map((c, i) => ({ id: String(i), name: c.name }));
                h += `<div class="graph-filters">
  <label>Category</label>
  <select id="filter-cat" aria-label="Filter by category">
    <option value="all">All categories</option>
    ${catOptions.map(c => `<option value="${c.id}" ${filterState.category === c.id ? 'selected' : ''}>${esc(c.name)}</option>`).join('')}
  </select>
  <label>Status</label>
  <select id="filter-status" aria-label="Filter by status">
    <option value="all" ${filterState.status === 'all' ? 'selected' : ''}>All</option>
    <option value="up" ${filterState.status === 'up' ? 'selected' : ''}>Up</option>
    <option value="degraded" ${filterState.status === 'degraded' ? 'selected' : ''}>Degraded</option>
    <option value="down" ${filterState.status === 'down' ? 'selected' : ''}>Down</option>
  </select>
  <div class="filter-group">
    <label>Time range</label>
    ${['7', '14', '30'].map(d => `<button type="button" class="chip ${filterState.timeRange === d ? 'active' : ''}" data-days="${d}">${d}d</button>`).join('')}
  </div>
</div>`;

                // === TOP ROW: Uptime chart (full width) ===
                const upHist = genFakeHistory(overallUp, numPoints);
                const now = Date.now();
                const dayMs = 86400 * 1000;
                const uptimeAreaData = upHist.map(function(y, i) { return { x: now - (numPoints - 1 - i) * dayMs, y: Math.round(y * 10) / 10 }; });
                h += `<div class="chart-card"><div class="card-title">Uptime % over time — ${filterState.timeRange}d<div class="legend"><span><span class="dot" style="background:var(--green)"></span> Uptime</span></div></div>`;
                h += makeGauge(overallUp);
                h += `<div id="chart-uptime-area" class="apex-chart-wrap"></div></div>`;

                // === SERVICE STATUS: HTTP + API  |  TCP  (side by side) ===
                const allSvcs = svcs || [];
                const httpSvcs = allSvcs.filter(s => !isTcp(s));
                const tcpSvcs = allSvcs.filter(s => isTcp(s));
                const httpIds = new Set(httpSvcs.map(s => s.id));
                const inAnyCat = new Set((cats || []).flatMap(c => c.service_ids || []));
                const httpByCat = (cats || []).map(cat => ({
                    name: cat.name,
                    icon: cat.icon,
                    services: (cat.service_ids || []).filter(id => httpIds.has(id)).map(id => sMap[id]).filter(Boolean)
                })).filter(g => g.services.length > 0);
                const httpUncategorized = httpSvcs.filter(s => !inAnyCat.has(s.id));

                h += `<div class="grid grid-svc-overview">`;

                // HTTP & API Services card — grouped by category, scrollable; collect for sparklines
                var allHttpForSpark = [];
                h += `<div class="card"><div class="card-title">Service Status — HTTP & API</div><div class="svc-table-outer">`;
                h += `<div class="svc-row header" style="grid-template-columns:1fr 52px 72px 80px 80px"><div>Service</div><div class="svc-spark" title="Connectivity"></div><div class="svc-val">Response</div><div class="svc-val">Status</div><div class="svc-val">30d Up</div></div>`;
                h += `<div class="svc-grid-wrap"><div class="svc-grid">`;
                httpByCat.forEach(grp => {
                    h += `<div class="svc-cat-header">${esc(grp.name)}</div>`;
                    grp.services.forEach(s => {
                        allHttpForSpark.push(s);
                        const up = s.uptime_pct != null ? Number(s.uptime_pct).toFixed(1) : '—';
                        const cls = s.status === 'up' ? 'svc-up' : s.status === 'down' ? 'svc-down' : s.status === 'degraded' ? 'svc-deg' : '';
                        const rt = s.status === 'down' ? '—' : (s.response_time_ms != null ? s.response_time_ms + ' ms' : '—');
                        var sid = (s.id || '').replace(/[^a-zA-Z0-9_.-]/g, '_');
                        h += `<div class="svc-row" style="grid-template-columns:1fr 52px 72px 80px 80px"><div class="svc-name"><span class="svc-dot ${s.status || 'unknown'}"></span><span class="svc-label">${esc(s.name)}</span></div><div class="svc-spark" id="spark-svc-${sid}"></div><div class="svc-val">${rt}</div><div class="svc-val ${cls}">${s.status || '?'}</div><div class="svc-val ${cls}">${up}%</div></div>`;
                    });
                });
                if (httpUncategorized.length > 0) {
                    h += `<div class="svc-cat-header">Other</div>`;
                    httpUncategorized.forEach(s => {
                        allHttpForSpark.push(s);
                        const up = s.uptime_pct != null ? Number(s.uptime_pct).toFixed(1) : '—';
                        const cls = s.status === 'up' ? 'svc-up' : s.status === 'down' ? 'svc-down' : s.status === 'degraded' ? 'svc-deg' : '';
                        const rt = s.status === 'down' ? '—' : (s.response_time_ms != null ? s.response_time_ms + ' ms' : '—');
                        var sid = (s.id || '').replace(/[^a-zA-Z0-9_.-]/g, '_');
                        h += `<div class="svc-row" style="grid-template-columns:1fr 52px 72px 80px 80px"><div class="svc-name"><span class="svc-dot ${s.status || 'unknown'}"></span><span class="svc-label">${esc(s.name)}</span></div><div class="svc-spark" id="spark-svc-${sid}"></div><div class="svc-val">${rt}</div><div class="svc-val ${cls}">${s.status || '?'}</div><div class="svc-val ${cls}">${up}%</div></div>`;
                    });
                }
                h += `</div></div></div></div>`;

                // TCP Services card — scrollable for consistency
                h += `<div class="card"><div class="card-title">Service Status — TCP</div><div class="svc-table-outer">`;
                h += `<div class="svc-row header" style="grid-template-columns:1fr 52px 72px 80px 80px"><div>Service</div><div class="svc-spark" title="Connectivity"></div><div class="svc-val">Response</div><div class="svc-val">Status</div><div class="svc-val">30d Up</div></div>`;
                h += `<div class="svc-grid-wrap"><div class="svc-grid">`;
                tcpSvcs.forEach(s => {
                    const up = s.uptime_pct != null ? Number(s.uptime_pct).toFixed(1) : '—';
                    const cls = s.status === 'up' ? 'svc-up' : s.status === 'down' ? 'svc-down' : s.status === 'degraded' ? 'svc-deg' : '';
                    const rt = s.status === 'down' ? '—' : (s.response_time_ms != null ? s.response_time_ms + ' ms' : '—');
                    var sid = (s.id || '').replace(/[^a-zA-Z0-9_.-]/g, '_');
                    h += `<div class="svc-row" style="grid-template-columns:1fr 52px 72px 80px 80px"><div class="svc-name"><span class="svc-dot ${s.status || 'unknown'}"></span><span class="svc-label">${esc(s.name)}</span></div><div class="svc-spark" id="spark-svc-${sid}"></div><div class="svc-val">${rt}</div><div class="svc-val ${cls}">${s.status || '?'}</div><div class="svc-val ${cls}">${up}%</div></div>`;
                });
                h += `</div></div></div></div>`;

                h += `</div>`;

                // === MID ROW: heatmap + incidents ===
                h += `<div class="grid grid-mid">`;

                h += `<div class="card"><div class="card-title">Outage calendar (30d)</div><div class="heatmap">`;
                ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(d => h += `<div class="heat-label">${d}</div>`);
                for (let i = 0; i < 35; i++) {
                    let seed = (i * 7 + 3) % 10;
                    const cls = seed < 6 ? 'heat-up' : seed < 8 ? 'heat-deg' : seed < 9 ? 'heat-down' : 'heat-none';
                    const day = i < 30 ? 30 - i : '';
                    h += `<div class="heat-cell ${cls}" title="Day ${day}">${day}</div>`;
                }
                h += `</div></div>`;

                h += `<div class="card"><div class="card-title">Recent Incidents</div>`;
                const incidents = (svcs || []).filter(s => s.status === 'down' || s.status === 'degraded');
                if (incidents.length > 0) {
                    incidents.slice(0, 5).forEach(s => {
                        const cls = s.status === 'down' ? '' : 'degraded';
                        h += `<div class="inc-card ${cls}"><div class="inc-title">${esc(s.name)}</div><div class="inc-meta"><span>${timeAgo(s.last_check)}</span><span>${esc(s.message)}</span></div><div class="inc-status ${s.status}">${s.status}</div></div>`;
                    });
                } else {
                    h += `<div class="inc-card resolved"><div class="inc-title">No active incidents</div><div class="inc-meta"><span>All systems operational</span></div><div class="inc-status resolved">Resolved</div></div>`;
                }
                h += `</div></div>`;

                // === Compare response time — pick up to 4 services, line/area chart ===
                const compareList = filtered.length ? filtered : (svcs || []);
                lastCompareList = compareList;
                if (!filterState.compareSelectedIds || filterState.compareSelectedIds.length === 0) {
                    filterState.compareSelectedIds = compareList.slice(0, 4).map(s => s.id);
                }
                h += `<div class="card" style="grid-column:1/-1"><div class="card-title">Compare response time — pick up to 4 services</div>`;
                h += `<div class="compare-svc-row">`;
                for (let i = 1; i <= 4; i++) {
                    const sel = (filterState.compareSelectedIds || [])[i - 1] || '';
                    h += `<label>Service ${i}</label><select id="compare-svc-${i}" class="compare-svc-select" data-slot="${i}">`;
                    h += `<option value="">— None —</option>`;
                    compareList.forEach(s => { h += `<option value="${esc(s.id)}" ${s.id === sel ? 'selected' : ''}>${esc(s.name)}</option>`; });
                    h += `</select>`;
                }
                h += `</div><div id="chart-compare-response"></div></div>`;

                // === BOT ROW: Status (ApexCharts multiple radialbars) + Bar chart + Categories ===
                h += `<div class="grid grid-bot">`;
                const total = sm.total_services || 1;
                const upPct = total ? Math.round((sm.up || 0) / total * 100) : 0;
                const degPct = total ? Math.round((sm.degraded || 0) / total * 100) : 0;
                const downPct = total ? Math.round((sm.down || 0) / total * 100) : 0;
                const unkPct = total ? Math.round((sm.unknown || 0) / total * 100) : 0;
                h += `<div class="card"><div class="card-title">Status breakdown</div><div id="chart-status-radial" class="apex-radial-wrap"></div></div>`;

                /* Uptime by category — HTML bar list: full names, fraction, percentage */
                const uptimeCatRows = (cats || []).map(cat => {
                    const ids = cat.service_ids || [];
                    const catUp = ids.filter(id => sMap[id] && sMap[id].status === 'up').length;
                    const pct = ids.length ? Math.round(catUp / ids.length * 100) : 0;
                    const color = pct >= 90 ? '#2ecc71' : pct >= 70 ? '#f1c40f' : '#e74c3c';
                    return { name: cat.name || '', up: catUp, total: ids.length, pct, color };
                }).filter(r => r.total > 0);
                h += `<div class="card"><div class="card-title">Uptime by category</div><div class="uptime-cat-list">`;
                uptimeCatRows.forEach(r => {
                    h += `<div class="uptime-cat-row"><div class="uptime-cat-label" title="${esc(r.name)}">${esc(r.name)}</div><div class="uptime-cat-bar-wrap"><div class="uptime-cat-bar" style="width:${r.pct}%;background:${r.color}"></div></div><div class="uptime-cat-values"><span class="uptime-cat-frac">${r.up}/${r.total}</span><span class="uptime-cat-pct" style="color:${r.color}">${r.pct}%</span></div></div>`;
                });
                h += `</div></div>`;

                h += `<div class="card"><div class="card-title">Categories</div><div class="cat-list">`;
                (cats || []).forEach(cat => {
                    const ids = cat.service_ids || [];
                    const catUp = ids.filter(id => sMap[id] && sMap[id].status === 'up').length;
                    const pct = ids.length ? (catUp / ids.length * 100).toFixed(0) : 0;
                    const color = pct >= 90 ? 'var(--green)' : pct >= 70 ? 'var(--yellow)' : 'var(--red)';
                    h += `<div class="cat-row"><span class="cat-pct-dot" style="background:${color}"></span><span class="cat-name">${esc(cat.name)}</span><span class="cat-meta">${catUp}/${ids.length}</span><span class="cat-pct" style="color:${color}">${pct}%</span></div>`;
                });
                h += `</div></div>`;

                app.innerHTML = h;

                // Destroy previous ApexCharts instances
                if (window.iranMonitorCharts) {
                    window.iranMonitorCharts.forEach(function(c) { try { c.destroy(); } catch(e) {} });
                    window.iranMonitorCharts = [];
                }
                compareChartRef = null;

                if (typeof ApexCharts !== 'undefined') {
                    var chartList = [];

                    // Status breakdown — multiple radialbars (https://apexcharts.com/javascript-chart-demos/radialbar-charts/multiple-radialbars/)
                    var radialEl = document.getElementById('chart-status-radial');
                    if (radialEl) {
                        var radialOpts = {
                            series: [upPct, degPct, downPct, unkPct],
                            chart: { type: 'radialBar', height: 280, background: 'transparent' },
                            plotOptions: {
                                radialBar: {
                                    dataLabels: {
                                        name: { fontSize: '12px' },
                                        value: { fontSize: '14px' },
                                        total: {
                                            show: true,
                                            label: 'Total',
                                            formatter: function() { return total + ' services'; }
                                        }
                                    }
                                }
                            },
                            labels: ['Up', 'Degraded', 'Down', 'Unknown'],
                            colors: ['#2ecc71', '#f1c40f', '#e74c3c', '#5c6a82'],
                            theme: { mode: 'dark' }
                        };
                        var radialChart = new ApexCharts(radialEl, radialOpts);
                        radialChart.render();
                        chartList.push(radialChart);
                    }

                    // Uptime over time — area chart github-style (https://apexcharts.com/javascript-chart-demos/area-charts/github-style/)
                    var uptimeEl = document.getElementById('chart-uptime-area');
                    if (uptimeEl && uptimeAreaData.length) {
                        var uptimeOpts = {
                            series: [{ name: 'Uptime %', data: uptimeAreaData }],
                            chart: { type: 'area', height: 220, toolbar: { show: false }, background: 'transparent' },
                            colors: ['#2ecc71'],
                            stroke: { width: 1, curve: 'smooth' },
                            dataLabels: { enabled: false },
                            fill: { type: 'solid', opacity: 0.2 },
                            xaxis: { type: 'datetime', labels: { style: { colors: '#5c6a82' } } },
                            yaxis: { min: 0, max: 100, labels: { style: { colors: '#5c6a82' } } },
                            grid: { borderColor: 'var(--border)', strokeDashArray: 2 },
                            tooltip: { theme: 'dark' },
                            theme: { mode: 'dark' }
                        };
                        var uptimeChart = new ApexCharts(uptimeEl, uptimeOpts);
                        uptimeChart.render();
                        chartList.push(uptimeChart);
                    }

                    // Row sparklines — current value only (no fake history); updates when data is fetched
                    var allSvcForSpark = allHttpForSpark.concat(tcpSvcs);
                    allSvcForSpark.forEach(function(svc) {
                        var sid = (svc.id || '').replace(/[^a-zA-Z0-9_.-]/g, '_');
                        var el = document.getElementById('spark-svc-' + sid);
                        if (!el) return;
                        var rt = svc.status === 'down' ? 0 : (svc.response_time_ms || 0);
                        var sparkData = [ { x: now - 3600000, y: rt }, { x: now, y: rt } ];
                        var sparkColor = svc.status === 'up' ? '#2ecc71' : svc.status === 'degraded' ? '#f1c40f' : svc.status === 'down' ? '#e74c3c' : '#5c6a82';
                        var sparkOpts = {
                            series: [{ name: 'ms', data: sparkData }],
                            chart: { type: 'area', height: 28, sparkline: { enabled: true }, toolbar: { show: false }, background: 'transparent' },
                            stroke: { width: 1, curve: 'stepline' },
                            fill: { type: 'solid', opacity: 0.25 },
                            colors: [sparkColor],
                            xaxis: { type: 'datetime', labels: { show: false }, axisBorder: { show: false }, axisTicks: { show: false } },
                            yaxis: { labels: { show: false }, min: 0 },
                            grid: { show: false, padding: { top: 2, right: 2, bottom: 2, left: 2 } },
                            tooltip: { theme: 'dark', y: { formatter: function(v) { return v + ' ms'; } } },
                            dataLabels: { enabled: false },
                            theme: { mode: 'dark' }
                        };
                        var sparkChart = new ApexCharts(el, sparkOpts);
                        sparkChart.render();
                        chartList.push(sparkChart);
                    });

                    // Compare response time — line/area chart for up to 4 selected services (https://apexcharts.com/javascript-chart-demos/mixed-charts/line-area/)
                    try {
                        function buildCompareSeries() {
                            var ids = [1, 2, 3, 4].map(function(i) { var el = document.getElementById('compare-svc-' + i); return el ? el.value : ''; }).filter(Boolean);
                            return ids.map(function(id) {
                                var svc = (lastCompareList || []).find(function(s) { return s && s.id === id; });
                                if (!svc) return null;
                                var vals = genFakeHistory(svc.response_time_ms || 100, 24);
                                var data = vals.map(function(y, i) {
                                    var t = now - (23 - i) * 3600000;
                                    return { x: t, y: Math.round(y) };
                                });
                                return { name: (svc.name || svc.id || 'Service'), data: data };
                            }).filter(Boolean);
                        }
                        var compareEl = document.getElementById('chart-compare-response');
                        if (compareEl) {
                            var compareSeries = buildCompareSeries();
                            var fallbackSeries = [{ name: 'No service selected', data: [{ x: now - 86400000, y: 0 }, { x: now, y: 0 }] }];
                            var seriesToUse = compareSeries.length ? compareSeries : fallbackSeries;
                            var compareOpts = {
                                series: seriesToUse,
                                chart: { type: 'area', height: 260, toolbar: { show: true }, zoom: { enabled: true }, background: 'transparent' },
                                stroke: { width: 2, curve: 'smooth' },
                                dataLabels: { enabled: false },
                                fill: { type: 'solid', opacity: 0.25 },
                                colors: SERIES_COLORS.slice(0, 4),
                                xaxis: { type: 'datetime', labels: { style: { colors: '#5c6a82' } } },
                                yaxis: { min: 0, labels: { style: { colors: '#5c6a82' }, formatter: function(v) { return v + ' ms'; } } },
                                grid: { borderColor: 'var(--border)', strokeDashArray: 2 },
                                legend: { position: 'top', horizontalAlign: 'right', labels: { colors: '#5c6a82' } },
                                tooltip: { theme: 'dark', y: { formatter: function(v) { return v + ' ms'; } }, x: { format: 'dd MMM HH:mm' } },
                                theme: { mode: 'dark' }
                            };
                            compareChartRef = new ApexCharts(compareEl, compareOpts);
                            compareChartRef.render();
                            chartList.push(compareChartRef);
                            [1, 2, 3, 4].forEach(function(i) {
                                var sel = document.getElementById('compare-svc-' + i);
                                if (sel) sel.addEventListener('change', function() {
                                    filterState.compareSelectedIds = [1, 2, 3, 4].map(function(j) {
                                        var e = document.getElementById('compare-svc-' + j);
                                        return e ? e.value : '';
                                    }).filter(Boolean);
                                    var next = buildCompareSeries();
                                    if (compareChartRef) compareChartRef.updateOptions({ series: next.length ? next : fallbackSeries });
                                });
                            });
                        }
                    } catch (compareErr) {
                        console.warn('Compare chart init failed:', compareErr);
                    }

                    window.iranMonitorCharts = chartList;
                }

                // Filter handlers (must run so re-render works)
                var fc = app.querySelector('#filter-cat');
                var fs = app.querySelector('#filter-status');
                if (fc) fc.addEventListener('change', function() { filterState.category = this.value; render(lastData); });
                if (fs) fs.addEventListener('change', function() { filterState.status = this.value; render(lastData); });
                app.querySelectorAll('.graph-filters .chip').forEach(btn => {
                    btn.addEventListener('click', function() { filterState.timeRange = this.dataset.days; render(lastData); });
                });
                } catch (e) {
                    console.error('Render error:', e);
                    app.innerHTML = '<div class="no-data"><h3>Error loading dashboard</h3><p>' + (e && e.message ? esc(e.message) : 'Check console for details') + '</p></div>';
                }
            }

            async function fetchData() { try { const r = await fetch(DATA_URL + '?t=' + Date.now()); if (!r.ok) throw 0; render(await r.json()) } catch (e) { app.innerHTML = '<div class="no-data"><h3>Waiting for Data</h3><p>Push to GitHub & enable Actions to start monitoring.</p><p style="margin-top:10px"><code>./run-check.sh</code></p></div>' } }
            fetchData(); setInterval(fetchData, REFRESH);
        })();
    </script>
</body>

</html>