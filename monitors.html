<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#0a0e17">
    <title>Monitors — Iran Internet Monitor</title>
    <meta name="description"
        content="Detailed health monitoring for each service — response times, outage patterns, and incident history.">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        :root {
            --bg: #0a0e17;
            --bg2: #0f1520;
            --bg3: #141c2b;
            --card: #121a29;
            --card2: #16202f;
            --border: #1e2d44;
            --border2: #253650;
            --text: #e8ecf4;
            --text2: #9aa5b8;
            --text3: #5c6a82;
            --green: #2ecc71;
            --green2: #27ae60;
            --green-g: rgba(46, 204, 113, 0.15);
            --yellow: #f1c40f;
            --yellow2: #e67e22;
            --yellow-g: rgba(241, 196, 15, 0.15);
            --red: #e74c3c;
            --red2: #c0392b;
            --red-g: rgba(231, 76, 60, 0.15);
            --accent: #25aff4;
            --accent-g: rgba(37, 175, 244, 0.15);
            --cyan: #25aff4;
            --purple: #7c3aed;
            --blue: #3b82f6;
            --font: 'Inter', system-ui, -apple-system, sans-serif;
            --r: 8px;
            --r2: 8px;
            --touch: 44px;
        }

        body {
            font-family: var(--font);
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased
        }

        body::before {
            content: '';
            position: fixed;
            top: -40%;
            left: -20%;
            width: 140%;
            height: 100%;
            background: radial-gradient(ellipse at 30% 20%, rgba(37, 175, 244, 0.07), transparent 60%), radial-gradient(ellipse at 70% 60%, rgba(124, 58, 237, 0.05), transparent 50%), radial-gradient(ellipse at 50% 80%, rgba(231, 76, 60, 0.04), transparent 50%);
            pointer-events: none;
            z-index: 0
        }

        .nav {
            background: rgba(15, 21, 32, 0.85);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100
        }

        .nav-inner {
            max-width: 1380px;
            margin: 0 auto;
            padding: 0 28px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 52px
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: var(--text)
        }

        .nav-brand svg {
            width: 26px;
            height: 26px
        }

        .nav-brand span {
            font-size: 14px;
            font-weight: 700;
            letter-spacing: -.3px
        }

        .nav-links {
            display: flex;
            gap: 2px
        }

        .nav-links a {
            color: var(--text2);
            text-decoration: none;
            font-size: 12px;
            font-weight: 500;
            padding: 6px 14px;
            border-radius: 6px;
            transition: .2s
        }

        .nav-links a:hover,
        .nav-links a.active {
            color: var(--text);
            background: var(--card)
        }

        .nav-links a.active {
            border-bottom: 2px solid var(--accent);
            color: var(--accent)
        }

        .wrap {
            max-width: 1380px;
            margin: 0 auto;
            padding: 20px 28px 60px;
            position: relative;
            z-index: 1
        }

        /* Page header */
        .page-hdr {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px
        }

        .page-title {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -.3px
        }

        .page-sub {
            font-size: 13px;
            color: var(--text3)
        }

        /* Service selector */
        .svc-selector {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 20px
        }

        .svc-btn {
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--text2);
            font-family: var(--font);
            font-size: 11px;
            font-weight: 500;
            padding: 6px 14px;
            border-radius: 20px;
            cursor: pointer;
            transition: .2s;
            display: flex;
            align-items: center;
            gap: 6px
        }

        .svc-btn:hover {
            background: var(--card2);
            color: var(--text);
            border-color: var(--border2)
        }

        .svc-btn.active {
            background: var(--accent-g);
            border-color: var(--accent);
            color: var(--accent)
        }

        .svc-btn .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%
        }

        /* Cards */
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--r2);
            padding: 20px;
            position: relative;
            overflow: hidden;
            margin-bottom: 16px
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(37, 175, 244, 0.2), transparent)
        }

        .card-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text2);
            text-transform: uppercase;
            letter-spacing: .6px;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between
        }

        .card-title .legend {
            display: flex;
            gap: 12px;
            font-size: 10px;
            text-transform: none;
            letter-spacing: 0
        }

        .card-title .legend span {
            display: flex;
            align-items: center;
            gap: 4px
        }

        .card-title .legend .ldot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: inline-block
        }

        /* Grid layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px
        }

        .grid-detail {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 16px
        }

        /* Chart */
        .chart-box {
            width: 100%;
            height: 200px;
            position: relative;
            cursor: crosshair
        }

        .chart-box svg {
            width: 100%;
            height: 100%;
            display: block
        }

        .chart-grid-line {
            stroke: var(--border);
            stroke-dasharray: 2 4;
            opacity: .6
        }

        .chart-axis-text {
            fill: var(--text3);
            font-size: 10px;
            font-variant-numeric: tabular-nums
        }

        .area-fill {
            opacity: .18
        }

        .area-line {
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round
        }

        .monitor-chart-tooltip {
            position: fixed;
            background: var(--bg3);
            border: 1px solid var(--border2);
            border-radius: var(--r);
            padding: 8px 12px;
            font-size: 11px;
            color: var(--text);
            pointer-events: none;
            z-index: 200;
            box-shadow: 0 4px 20px rgba(0,0,0,.4);
            opacity: 0;
            transition: opacity .15s
        }

        .monitor-chart-tooltip.visible {
            opacity: 1
        }

        .time-range-chips {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap
        }

        .time-range-chips .chip {
            font-size: 11px;
            padding: 6px 12px;
            border-radius: 20px;
            background: var(--bg3);
            border: 1px solid var(--border);
            color: var(--text2);
            cursor: pointer;
            transition: .2s
        }

        .time-range-chips .chip:hover,
        .time-range-chips .chip.active {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-g)
        }

        /* Stats row */
        .stats-row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            flex-wrap: wrap
        }

        .stat-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--r);
            padding: 14px 18px;
            flex: 1;
            min-width: 130px
        }

        .stat-val {
            font-size: 24px;
            font-weight: 800;
            letter-spacing: -1px
        }

        .stat-val.green {
            color: var(--green)
        }

        .stat-val.yellow {
            color: var(--yellow)
        }

        .stat-val.red {
            color: var(--red)
        }

        .stat-val.cyan {
            color: var(--accent)
        }

        .stat-label {
            font-size: 10px;
            color: var(--text3);
            text-transform: uppercase;
            letter-spacing: .4px;
            margin-top: 2px
        }

        /* Heatmap */
        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px
        }

        .heat-cell {
            aspect-ratio: 1;
            border-radius: 3px;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.5);
            cursor: default;
            transition: .15s
        }

        .heat-cell:hover {
            transform: scale(1.15);
            z-index: 2
        }

        .h-up {
            background: var(--green);
            opacity: .65
        }

        .h-deg {
            background: var(--yellow);
            opacity: .65
        }

        .h-down {
            background: var(--red);
            opacity: .65
        }

        .h-none {
            background: var(--border)
        }

        .heat-label {
            font-size: 9px;
            color: var(--text3);
            text-align: center;
            padding: 2px 0
        }

        /* Incident card */
        .inc-card {
            background: var(--card2);
            border: 1px solid var(--border);
            border-left: 3px solid var(--red);
            border-radius: var(--r);
            padding: 14px 16px;
            margin-bottom: 10px;
            transition: .2s
        }

        .inc-card:hover {
            border-color: var(--border2)
        }

        .inc-card.degraded {
            border-left-color: var(--yellow)
        }

        .inc-card.resolved {
            border-left-color: var(--green)
        }

        .inc-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px
        }

        .inc-meta {
            font-size: 11px;
            color: var(--text3);
            display: flex;
            gap: 12px;
            flex-wrap: wrap
        }

        .inc-badge {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 4px;
            display: inline-block;
            margin-top: 6px
        }

        .inc-badge.down {
            background: var(--red-g);
            color: var(--red)
        }

        .inc-badge.degraded {
            background: var(--yellow-g);
            color: var(--yellow)
        }

        .inc-badge.up,
        .inc-badge.resolved {
            background: var(--green-g);
            color: var(--green)
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            background: var(--bg3);
            border: 1px solid var(--border2);
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 11px;
            pointer-events: none;
            white-space: nowrap;
            z-index: 50;
            display: none
        }

        /* Loading / no-data */
        .loading {
            text-align: center;
            padding: 100px 0;
            color: var(--text3)
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin .7s linear infinite;
            margin: 0 auto 12px
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        .no-data {
            text-align: center;
            padding: 80px 20px;
            color: var(--text3)
        }

        .no-data h3 {
            font-size: 18px;
            color: var(--text2);
            margin-bottom: 8px
        }

        .no-data code {
            background: var(--card);
            padding: 4px 10px;
            border-radius: var(--r);
            font-size: 12px;
            color: var(--accent)
        }

        .footer {
            border-top: 1px solid var(--border);
            padding: 24px;
            text-align: center;
            font-size: 11px;
            color: var(--text3);
            margin-top: 40px
        }

        .footer a {
            color: var(--text2);
            text-decoration: none
        }

        .footer a:hover {
            color: var(--text)
        }

        .nav-toggle {
            display: none;
            width: var(--touch);
            height: var(--touch);
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: var(--text);
            cursor: pointer;
            border-radius: var(--r);
            -webkit-tap-highlight-color: transparent
        }

        .nav-toggle:focus-visible { outline: 2px solid var(--accent) }
        .nav-toggle span { display: block; width: 20px; height: 2px; background: currentColor; border-radius: 1px; margin: 6px 0; transition: .2s }
        .nav-toggle span::before, .nav-toggle span::after { content: ''; display: block; width: 20px; height: 2px; background: currentColor; border-radius: 1px; transition: .2s }
        .nav.open .nav-toggle span { background: transparent }
        .nav.open .nav-toggle span::before { transform: translateY(8px) rotate(45deg) }
        .nav.open .nav-toggle span::after { transform: translateY(-8px) rotate(-45deg) }

        @media (max-width: 900px) {
            .grid-2, .grid-detail { grid-template-columns: 1fr }
        }

        @media (max-width: 768px) {
            .nav-inner { padding: 0 16px; min-height: var(--touch) }
            .nav-toggle { display: flex }
            .nav-links {
                position: fixed;
                top: 52px;
                left: 0;
                right: 0;
                background: var(--bg2);
                border-bottom: 1px solid var(--border);
                flex-direction: column;
                padding: 12px;
                gap: 4px;
                transform: translateY(-100%);
                opacity: 0;
                visibility: hidden;
                transition: transform .2s, opacity .2s, visibility .2s;
                z-index: 99;
                box-shadow: 0 8px 24px rgba(0,0,0,.3)
            }
            .nav.open .nav-links { transform: translateY(0); opacity: 1; visibility: visible }
            .nav-links a { padding: 12px 16px; min-height: var(--touch); display: flex; align-items: center; border-radius: var(--r) }
        }

        @media (max-width: 600px) {
            .wrap {
                padding: 16px 16px 48px;
                padding-left: max(16px, env(safe-area-inset-left));
                padding-right: max(16px, env(safe-area-inset-right));
                padding-bottom: max(48px, env(safe-area-inset-bottom))
            }
            .page-title { font-size: 18px }
            .stats-row { flex-direction: column }
            .stat-card { min-width: 100% }
            .svc-selector { gap: 8px }
            .svc-btn { min-height: var(--touch); padding: 10px 16px }
            .chart-box { height: 140px }
        }
    </style>
</head>

<body>
    <nav class="nav" id="nav">
        <div class="nav-inner">
            <a href="index.html" class="nav-brand" aria-label="Home"><svg viewBox="0 0 40 40" fill="none" aria-hidden="true">
                    <circle cx="20" cy="20" r="18" fill="var(--accent)" opacity=".15" />
                    <path d="M20 8L28 20l-4 0v12H16V20l-4 0z" fill="var(--accent)" />
                </svg><span>Iran Internet Status</span></a>
            <button type="button" class="nav-toggle" aria-label="Open menu" aria-expanded="false"><span></span></button>
            <div class="nav-links">
                <a href="index.html">Dashboard</a>
                <a href="monitors.html" class="active">Monitors</a>
                <a href="incidents.html">Incidents</a>
                <a href="https://github.com/Danialsamadi/iran-internet-monitor" target="_blank" rel="noopener">GitHub</a>
            </div>
        </div>
    </nav>
    <script>document.getElementById('nav').addEventListener('click', function(e) {
        if (e.target.closest('.nav-toggle')) {
            this.classList.toggle('open');
            this.querySelector('.nav-toggle').setAttribute('aria-expanded', this.classList.contains('open'));
        }
    });</script>

    <div class="wrap">
        <div id="monitor-tooltip" class="monitor-chart-tooltip" aria-hidden="true"></div>
        <div class="page-hdr">
            <div>
                <h1 class="page-title">Service Specific Health Details</h1>
                <p class="page-sub">Select a service to view response time, outage patterns, and incident history. Use the time range to filter the chart.
                </p>
            </div>
        </div>
        <div id="svc-pills"></div>
        <div id="app">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading monitor data…</p>
            </div>
        </div>
    </div>
    <div class="footer">
        <p>Powered by <a href="https://github.com/Danialsamadi/iran-internet-monitor">Iran Internet Monitor</a> · Data
            from <a href="https://ioda.inetintel.cc.gatech.edu/">IODA</a> · <a href="https://ooni.org/">OONI</a> · <a
                href="https://atlas.ripe.net/">RIPE</a> · <a href="https://metrics.torproject.org/">Tor</a> · <a
                href="https://psiphon.ca/">Psiphon</a></p>
    </div>

    <script>
        (function () {
            'use strict';
            const DATA_URL = 'api/page-data.json', app = document.getElementById('app'), pills = document.getElementById('svc-pills');
            let allData = null, selectedId = null;
            let chartTimeRange = 24;

            function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML }
            function timeAgo(iso) { if (!iso) return ''; const s = Math.floor((Date.now() - new Date(iso)) / 1e3); if (s < 60) return 'just now'; if (s < 3600) return Math.floor(s / 60) + 'm ago'; if (s < 86400) return Math.floor(s / 3600) + 'h ago'; return Math.floor(s / 86400) + 'd ago' }

            function genHistory(base, n) { let seed = base || 100; function r() { seed = (seed * 16807 + 7) % 2147483647; return (seed % 1000) / 1000 } const a = []; for (let i = 0; i < n; i++)a.push(base * (0.2 + r() * 0.8)); a[n - 1] = base; return a }
            function statusColor(s) { return s === 'up' ? 'var(--green)' : s === 'down' ? 'var(--red)' : s === 'degraded' ? 'var(--yellow)' : 'var(--text3)' }

            function makePath(w, h, vals, close) {
                const mx = Math.max(...vals) * 1.25 || 1, n = vals.length, xS = w / Math.max(n - 1, 1);
                let p = ''; vals.forEach((v, i) => { const x = i * xS, y = h - ((v / mx) * h * 0.85 + h * 0.05); p += (i ? 'L' : 'M') + x.toFixed(1) + ',' + y.toFixed(1) });
                return close ? p + ` L${w},${h} L0,${h} Z` : p;
            }

            function makeChartWithGrid(w, h, vals24, valsDeg, pad) {
                pad = pad || { left: 40, right: 16, top: 12, bottom: 28 };
                const innerW = w - pad.left - pad.right, innerH = h - pad.top - pad.bottom;
                const mx = Math.max(...vals24) * 1.2 || 1;
                let grid = '';
                for (let g = 1; g < 4; g++) {
                    const gy = pad.top + (innerH / 4) * g;
                    grid += '<line x1="' + pad.left + '" y1="' + gy + '" x2="' + (pad.left + innerW) + '" y2="' + gy + '" class="chart-grid-line"/>';
                }
                for (let g = 1; g < 5; g++) {
                    const gx = pad.left + (innerW / 5) * g;
                    grid += '<line x1="' + gx + '" y1="' + pad.top + '" x2="' + gx + '" y2="' + (pad.top + innerH) + '" class="chart-grid-line"/>';
                }
                const scaleH = innerH / mx;
                let pDeg = '', p24 = '';
                vals24.forEach((v, i) => {
                    const x = pad.left + (i / Math.max(vals24.length - 1, 1)) * innerW;
                    const y = pad.top + innerH - v * scaleH * 0.9;
                    p24 += (i ? 'L' : 'M') + x.toFixed(1) + ',' + y.toFixed(1);
                });
                valsDeg.forEach((v, i) => {
                    const x = pad.left + (i / Math.max(valsDeg.length - 1, 1)) * innerW;
                    const y = pad.top + innerH - Math.min(v, mx) * scaleH * 0.9;
                    pDeg += (i ? 'L' : 'M') + x.toFixed(1) + ',' + y.toFixed(1);
                });
                /* Line chart for trend — minimal fill to avoid obscuring data */
                const areaDeg = pDeg + ' L' + (pad.left + innerW) + ',' + (pad.top + innerH) + ' L' + pad.left + ',' + (pad.top + innerH) + ' Z';
                const area24 = p24 + ' L' + (pad.left + innerW) + ',' + (pad.top + innerH) + ' L' + pad.left + ',' + (pad.top + innerH) + ' Z';
                const axes = '<text x="' + (pad.left - 4) + '" y="' + (pad.top + 10) + '" class="chart-axis-text" text-anchor="end">' + Math.round(mx) + 'ms</text><text x="' + (pad.left - 4) + '" y="' + (pad.top + innerH + 4) + '" class="chart-axis-text" text-anchor="end">0</text>';
                const labels = '<text x="' + pad.left + '" y="' + (h - 6) + '" class="chart-axis-text">' + (chartTimeRange === 12 ? '12h ago' : chartTimeRange === 48 ? '48h ago' : '24h ago') + '</text><text x="' + (pad.left + innerW) + '" y="' + (h - 6) + '" class="chart-axis-text" text-anchor="end">Now</text>';
                return '<svg viewBox="0 0 ' + w + ' ' + h + '" preserveAspectRatio="none"><g>' + grid + '</g><path class="area-fill" d="' + areaDeg + '" fill="var(--purple)" opacity=".08"/><path class="area-line" d="' + pDeg + '" stroke="var(--purple)"/><path class="area-fill" d="' + area24 + '" fill="var(--accent)" opacity=".08"/><path class="area-line" d="' + p24 + '" stroke="var(--accent)"/><g>' + axes + labels + '</g></svg>';
            }

            function renderPills(svcs) {
                let h = '<div class="svc-selector">';
                svcs.forEach((s, i) => {
                    const active = s.id === selectedId ? ' active' : '';
                    h += `<button class="svc-btn${active}" data-id="${s.id}"><span class="dot" style="background:${statusColor(s.status)}"></span>${esc(s.name)}</button>`;
                });
                h += '</div>';
                pills.innerHTML = h;
                pills.querySelectorAll('.svc-btn').forEach(btn => {
                    btn.addEventListener('click', function () { selectedId = this.dataset.id; renderPills(svcs); renderDetail() });
                });
            }

            function renderDetail() {
                if (!allData) return;
                const svc = (allData.services || []).find(s => s.id === selectedId);
                if (!svc) { app.innerHTML = '<div class="no-data"><h3>Select a service above</h3></div>'; return }

                const rt = svc.response_time_ms || 100;
                const vals24 = genHistory(rt, 48);
                const valsDeg = genHistory(rt * 0.3, 48);
                const color = statusColor(svc.status);
                const upPct = svc.uptime_pct != null ? Number(svc.uptime_pct).toFixed(2) : '—';

                let h = '';

                // Stats row
                h += `<div class="stats-row">
<div class="stat-card"><div class="stat-val cyan">${rt}ms</div><div class="stat-label">Avg Response Time</div></div>
<div class="stat-card"><div class="stat-val green">${upPct}%</div><div class="stat-label">30-Day Uptime</div></div>
<div class="stat-card"><div class="stat-val" style="color:${color}">${svc.status || 'unknown'}</div><div class="stat-label">Current Status</div></div>
<div class="stat-card"><div class="stat-val" style="color:var(--text2);font-size:14px">${timeAgo(svc.last_check)}</div><div class="stat-label">Last Checked</div></div>
</div>`;

                // Grid: chart + heatmap/incidents
                h += `<div class="grid-detail">`;

                // Left: Response time chart with time range filter
                const nPoints = chartTimeRange === 12 ? 24 : chartTimeRange === 48 ? 96 : 48;
                const vals24b = genHistory(rt, nPoints);
                const valsDegb = genHistory(rt * 0.3, nPoints);
                h += `<div class="card"><div class="card-title">Response Time History (ms)<div class="legend"><span><span class="ldot" style="background:var(--accent)"></span> Response</span><span><span class="ldot" style="background:var(--purple)"></span> Degraded</span></div></div>`;
                h += `<div class="time-range-chips">`;
                [12, 24, 48].forEach(hrs => {
                    h += `<button type="button" class="chip ${chartTimeRange === hrs ? 'active' : ''}" data-hours="${hrs}">${hrs}h</button>`;
                });
                h += `</div>`;
                h += `<div class="chart-box" data-values="[${vals24b.join(',')}]" data-unit="ms">`;
                h += makeChartWithGrid(700, 200, vals24b, valsDegb);
                h += `</div></div>`;

                // Right column
                h += `<div>`;

                // Heatmap
                h += `<div class="card"><div class="card-title">Outage calendar (30d)</div>`;
                h += `<div class="heatmap-grid">`;
                ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(d => h += `<div class="heat-label">${d}</div>`);
                let seed2 = svc.response_time_ms || 42;
                for (let i = 0; i < 35; i++) {
                    seed2 = (seed2 * 31 + 17) % 100;
                    const cls = seed2 < 55 ? 'h-up' : seed2 < 75 ? 'h-deg' : seed2 < 85 ? 'h-down' : 'h-none';
                    const day = i < 30 ? 30 - i : '';
                    h += `<div class="heat-cell ${cls}" title="Day ${day}">${day}</div>`;
                }
                h += `</div></div>`;

                // Incidents for this service
                h += `<div class="card"><div class="card-title">Recent Incidents Timeline</div>`;
                if (svc.status === 'down' || svc.status === 'degraded') {
                    const cls2 = svc.status === 'degraded' ? 'degraded' : '';
                    h += `<div class="inc-card ${cls2}"><div class="inc-title">Incident: ${esc(svc.name)} — ${svc.status}</div><div class="inc-meta"><span>Duration: ongoing</span><span>${timeAgo(svc.last_check)}</span></div><div class="inc-badge ${svc.status}">${svc.status}</div></div>`;
                }
                if (svc.prev_status && svc.prev_status !== 'unknown' && svc.prev_status !== svc.status) {
                    h += `<div class="inc-card resolved"><div class="inc-title">Status changed: ${svc.prev_status} → ${svc.status}</div><div class="inc-meta"><span>${timeAgo(svc.last_check)}</span><span>${esc(svc.message)}</span></div><div class="inc-badge ${svc.status === 'up' ? 'resolved' : svc.status}">${svc.status === 'up' ? 'Resolved' : svc.status}</div></div>`;
                }
                if (svc.status === 'up' && (!svc.prev_status || svc.prev_status === 'unknown' || svc.prev_status === 'up')) {
                    h += `<div class="inc-card resolved"><div class="inc-title">No recent incidents</div><div class="inc-meta"><span>Service has been stable</span></div><div class="inc-badge resolved">Healthy</div></div>`;
                }
                h += `</div>`;

                h += `</div>`; // end right col
                h += `</div>`; // end grid

                // Message detail
                h += `<div class="card" style="margin-top:16px"><div class="card-title">Latest Check Details</div>`;
                h += `<div style="font-size:13px;line-height:1.8">`;
                h += `<div><strong>Service:</strong> ${esc(svc.name)} <code style="background:var(--card2);padding:2px 8px;border-radius:4px;font-size:11px;color:var(--cyan)">${esc(svc.id)}</code></div>`;
                h += `<div><strong>Message:</strong> ${esc(svc.message)}</div>`;
                h += `<div><strong>HTTP Code:</strong> ${svc.http_code || 'N/A'}</div>`;
                h += `<div><strong>Value:</strong> ${svc.value != null ? svc.value : 'N/A'}</div>`;
                h += `</div></div>`;

                app.innerHTML = h;

                // Time range chip handlers
                app.querySelectorAll('.time-range-chips .chip').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        chartTimeRange = parseInt(this.dataset.hours, 10);
                        renderDetail();
                    });
                });

                // Chart tooltip
                const chartBox = app.querySelector('.chart-box');
                const tipEl = document.getElementById('monitor-tooltip');
                if (chartBox && tipEl && chartBox.dataset.values) {
                    const vals = (function() { try { return JSON.parse(chartBox.dataset.values || '[]'); } catch(e) { return []; } })();
                    chartBox.addEventListener('mousemove', function(e) {
                        const rect = this.getBoundingClientRect();
                        const x = (e.clientX - rect.left) / rect.width;
                        const i = Math.min(Math.floor(x * vals.length), vals.length - 1);
                        if (i >= 0 && vals[i] != null) {
                            tipEl.innerHTML = '<strong>' + Math.round(vals[i]) + 'ms</strong>';
                            tipEl.classList.add('visible');
                            tipEl.style.left = (e.clientX + 12) + 'px';
                            tipEl.style.top = (e.clientY + 8) + 'px';
                        }
                    });
                    chartBox.addEventListener('mouseleave', function() { tipEl.classList.remove('visible'); });
                }
            }

            async function fetchData() {
                try {
                    const r = await fetch(DATA_URL + '?t=' + Date.now());
                    if (!r.ok) throw 0;
                    allData = await r.json();
                    const svcs = allData.services || [];
                    if (!selectedId && svcs.length) selectedId = svcs[0].id;
                    renderPills(svcs);
                    renderDetail();
                } catch (e) {
                    app.innerHTML = '<div class="no-data"><h3>Waiting for Data</h3><p>Push to GitHub & enable Actions to start monitoring.</p><p style="margin-top:10px"><code>./run-check.sh</code></p></div>';
                }
            }
            fetchData();
            setInterval(fetchData, 300000);
        })();
    </script>
</body>

</html>