<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitors — Iran Internet Monitor</title>
    <meta name="description"
        content="Detailed health monitoring for each service — response times, outage patterns, and incident history.">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        :root {
            --bg: #0a0e17;
            --bg2: #0f1520;
            --bg3: #141c2b;
            --card: #121a29;
            --card2: #16202f;
            --border: #1e2d44;
            --border2: #253650;
            --text: #e8ecf4;
            --text2: #9aa5b8;
            --text3: #5c6a82;
            --green: #2ecc71;
            --green2: #27ae60;
            --green-g: rgba(46, 204, 113, 0.15);
            --yellow: #f1c40f;
            --yellow2: #e67e22;
            --yellow-g: rgba(241, 196, 15, 0.15);
            --red: #e74c3c;
            --red2: #c0392b;
            --red-g: rgba(231, 76, 60, 0.15);
            --cyan: #00d2ff;
            --purple: #7c3aed;
            --blue: #3b82f6;
            --font: 'Inter', system-ui, sans-serif;
            --r: 10px;
            --r2: 14px;
        }

        body {
            font-family: var(--font);
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased
        }

        body::before {
            content: '';
            position: fixed;
            top: -40%;
            left: -20%;
            width: 140%;
            height: 100%;
            background: radial-gradient(ellipse at 30% 20%, rgba(0, 210, 255, 0.06), transparent 60%), radial-gradient(ellipse at 70% 60%, rgba(124, 58, 237, 0.05), transparent 50%), radial-gradient(ellipse at 50% 80%, rgba(231, 76, 60, 0.04), transparent 50%);
            pointer-events: none;
            z-index: 0
        }

        .nav {
            background: rgba(15, 21, 32, 0.85);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100
        }

        .nav-inner {
            max-width: 1380px;
            margin: 0 auto;
            padding: 0 28px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 52px
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: var(--text)
        }

        .nav-brand svg {
            width: 26px;
            height: 26px
        }

        .nav-brand span {
            font-size: 14px;
            font-weight: 700;
            letter-spacing: -.3px
        }

        .nav-links {
            display: flex;
            gap: 2px
        }

        .nav-links a {
            color: var(--text2);
            text-decoration: none;
            font-size: 12px;
            font-weight: 500;
            padding: 6px 14px;
            border-radius: 6px;
            transition: .2s
        }

        .nav-links a:hover,
        .nav-links a.active {
            color: var(--text);
            background: var(--card)
        }

        .nav-links a.active {
            border-bottom: 2px solid var(--cyan)
        }

        .wrap {
            max-width: 1380px;
            margin: 0 auto;
            padding: 20px 28px 60px;
            position: relative;
            z-index: 1
        }

        /* Page header */
        .page-hdr {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px
        }

        .page-title {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -.3px
        }

        .page-sub {
            font-size: 13px;
            color: var(--text3)
        }

        /* Service selector */
        .svc-selector {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 20px
        }

        .svc-btn {
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--text2);
            font-family: var(--font);
            font-size: 11px;
            font-weight: 500;
            padding: 6px 14px;
            border-radius: 20px;
            cursor: pointer;
            transition: .2s;
            display: flex;
            align-items: center;
            gap: 6px
        }

        .svc-btn:hover {
            background: var(--card2);
            color: var(--text);
            border-color: var(--border2)
        }

        .svc-btn.active {
            background: rgba(0, 210, 255, 0.12);
            border-color: var(--cyan);
            color: var(--cyan)
        }

        .svc-btn .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%
        }

        /* Cards */
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--r2);
            padding: 20px;
            position: relative;
            overflow: hidden;
            margin-bottom: 16px
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(0, 210, 255, 0.15), transparent)
        }

        .card-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text2);
            text-transform: uppercase;
            letter-spacing: .6px;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between
        }

        .card-title .legend {
            display: flex;
            gap: 12px;
            font-size: 10px;
            text-transform: none;
            letter-spacing: 0
        }

        .card-title .legend span {
            display: flex;
            align-items: center;
            gap: 4px
        }

        .card-title .legend .ldot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: inline-block
        }

        /* Grid layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px
        }

        .grid-detail {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 16px
        }

        /* Chart */
        .chart-box {
            width: 100%;
            height: 180px;
            position: relative
        }

        .chart-box svg {
            width: 100%;
            height: 100%
        }

        .area-fill {
            opacity: .18
        }

        .area-line {
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round
        }

        /* Stats row */
        .stats-row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            flex-wrap: wrap
        }

        .stat-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--r);
            padding: 14px 18px;
            flex: 1;
            min-width: 130px
        }

        .stat-val {
            font-size: 24px;
            font-weight: 800;
            letter-spacing: -1px
        }

        .stat-val.green {
            color: var(--green)
        }

        .stat-val.yellow {
            color: var(--yellow)
        }

        .stat-val.red {
            color: var(--red)
        }

        .stat-val.cyan {
            color: var(--cyan)
        }

        .stat-label {
            font-size: 10px;
            color: var(--text3);
            text-transform: uppercase;
            letter-spacing: .4px;
            margin-top: 2px
        }

        /* Heatmap */
        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px
        }

        .heat-cell {
            aspect-ratio: 1;
            border-radius: 3px;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.5);
            cursor: default;
            transition: .15s
        }

        .heat-cell:hover {
            transform: scale(1.15);
            z-index: 2
        }

        .h-up {
            background: var(--green);
            opacity: .65
        }

        .h-deg {
            background: var(--yellow);
            opacity: .65
        }

        .h-down {
            background: var(--red);
            opacity: .65
        }

        .h-none {
            background: var(--border)
        }

        .heat-label {
            font-size: 9px;
            color: var(--text3);
            text-align: center;
            padding: 2px 0
        }

        /* Incident card */
        .inc-card {
            background: var(--card2);
            border: 1px solid var(--border);
            border-left: 3px solid var(--red);
            border-radius: var(--r);
            padding: 14px 16px;
            margin-bottom: 10px;
            transition: .2s
        }

        .inc-card:hover {
            border-color: var(--border2)
        }

        .inc-card.degraded {
            border-left-color: var(--yellow)
        }

        .inc-card.resolved {
            border-left-color: var(--green)
        }

        .inc-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px
        }

        .inc-meta {
            font-size: 11px;
            color: var(--text3);
            display: flex;
            gap: 12px;
            flex-wrap: wrap
        }

        .inc-badge {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 4px;
            display: inline-block;
            margin-top: 6px
        }

        .inc-badge.down {
            background: var(--red-g);
            color: var(--red)
        }

        .inc-badge.degraded {
            background: var(--yellow-g);
            color: var(--yellow)
        }

        .inc-badge.up,
        .inc-badge.resolved {
            background: var(--green-g);
            color: var(--green)
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            background: var(--bg3);
            border: 1px solid var(--border2);
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 11px;
            pointer-events: none;
            white-space: nowrap;
            z-index: 50;
            display: none
        }

        /* Loading / no-data */
        .loading {
            text-align: center;
            padding: 100px 0;
            color: var(--text3)
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top-color: var(--cyan);
            border-radius: 50%;
            animation: spin .7s linear infinite;
            margin: 0 auto 12px
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        .no-data {
            text-align: center;
            padding: 80px 20px;
            color: var(--text3)
        }

        .no-data h3 {
            font-size: 18px;
            color: var(--text2);
            margin-bottom: 8px
        }

        .no-data code {
            background: var(--card);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            color: var(--cyan)
        }

        .footer {
            border-top: 1px solid var(--border);
            padding: 24px;
            text-align: center;
            font-size: 11px;
            color: var(--text3);
            margin-top: 40px
        }

        .footer a {
            color: var(--text2);
            text-decoration: none
        }

        .footer a:hover {
            color: var(--text)
        }

        @media(max-width:900px) {

            .grid-2,
            .grid-detail {
                grid-template-columns: 1fr
            }
        }

        @media(max-width:600px) {
            .wrap {
                padding: 12px 14px 40px
            }

            .stats-row {
                flex-direction: column
            }
        }
    </style>
</head>

<body>
    <nav class="nav">
        <div class="nav-inner">
            <a href="index.html" class="nav-brand"><svg viewBox="0 0 40 40" fill="none">
                    <circle cx="20" cy="20" r="18" fill="#00d2ff" opacity=".15" />
                    <path d="M20 8L28 20l-4 0v12H16V20l-4 0z" fill="#00d2ff" />
                </svg><span>Iran Internet Health & Uptime Monitor</span></a>
            <div class="nav-links"><a href="index.html">Dashboard</a><a href="monitors.html"
                    class="active">Monitors</a><a href="incidents.html">Incidents</a><a
                    href="https://github.com/Danialsamadi/iran-internet-monitor" target="_blank">GitHub</a></div>
        </div>
    </nav>

    <div class="wrap">
        <div class="page-hdr">
            <div>
                <h1 class="page-title">Service Specific Health Details</h1>
                <p class="page-sub">Select a service to view 24h response time, outage patterns, and incident history
                </p>
            </div>
        </div>
        <div id="svc-pills"></div>
        <div id="app">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading monitor data…</p>
            </div>
        </div>
    </div>
    <div class="footer">
        <p>Powered by <a href="https://github.com/Danialsamadi/iran-internet-monitor">Iran Internet Monitor</a> · Data
            from <a href="https://ioda.inetintel.cc.gatech.edu/">IODA</a> · <a href="https://ooni.org/">OONI</a> · <a
                href="https://atlas.ripe.net/">RIPE</a> · <a href="https://metrics.torproject.org/">Tor</a> · <a
                href="https://psiphon.ca/">Psiphon</a></p>
    </div>

    <script>
        (function () {
            'use strict';
            const DATA_URL = 'api/page-data.json', app = document.getElementById('app'), pills = document.getElementById('svc-pills');
            let allData = null, selectedId = null;

            function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML }
            function timeAgo(iso) { if (!iso) return ''; const s = Math.floor((Date.now() - new Date(iso)) / 1e3); if (s < 60) return 'just now'; if (s < 3600) return Math.floor(s / 60) + 'm ago'; if (s < 86400) return Math.floor(s / 3600) + 'h ago'; return Math.floor(s / 86400) + 'd ago' }

            function genHistory(base, n) { let seed = base || 100; function r() { seed = (seed * 16807 + 7) % 2147483647; return (seed % 1000) / 1000 } const a = []; for (let i = 0; i < n; i++)a.push(base * (0.2 + r() * 0.8)); a[n - 1] = base; return a }
            function statusColor(s) { return s === 'up' ? 'var(--green)' : s === 'down' ? 'var(--red)' : s === 'degraded' ? 'var(--yellow)' : 'var(--text3)' }

            function makePath(w, h, vals, close) {
                const mx = Math.max(...vals) * 1.25 || 1, n = vals.length, xS = w / Math.max(n - 1, 1);
                let p = ''; vals.forEach((v, i) => { const x = i * xS, y = h - ((v / mx) * h * 0.85 + h * 0.05); p += (i ? 'L' : 'M') + x.toFixed(1) + ',' + y.toFixed(1) });
                return close ? p + ` L${w},${h} L0,${h} Z` : p;
            }

            function renderPills(svcs) {
                let h = '<div class="svc-selector">';
                svcs.forEach((s, i) => {
                    const active = s.id === selectedId ? ' active' : '';
                    h += `<button class="svc-btn${active}" data-id="${s.id}"><span class="dot" style="background:${statusColor(s.status)}"></span>${esc(s.name)}</button>`;
                });
                h += '</div>';
                pills.innerHTML = h;
                pills.querySelectorAll('.svc-btn').forEach(btn => {
                    btn.addEventListener('click', function () { selectedId = this.dataset.id; renderPills(svcs); renderDetail() });
                });
            }

            function renderDetail() {
                if (!allData) return;
                const svc = (allData.services || []).find(s => s.id === selectedId);
                if (!svc) { app.innerHTML = '<div class="no-data"><h3>Select a service above</h3></div>'; return }

                const rt = svc.response_time_ms || 100;
                const vals24 = genHistory(rt, 48);
                const valsDeg = genHistory(rt * 0.3, 48);
                const color = statusColor(svc.status);
                const upPct = svc.uptime_pct != null ? Number(svc.uptime_pct).toFixed(2) : '—';

                let h = '';

                // Stats row
                h += `<div class="stats-row">
<div class="stat-card"><div class="stat-val cyan">${rt}ms</div><div class="stat-label">Avg Response Time</div></div>
<div class="stat-card"><div class="stat-val green">${upPct}%</div><div class="stat-label">30-Day Uptime</div></div>
<div class="stat-card"><div class="stat-val" style="color:${color}">${svc.status || 'unknown'}</div><div class="stat-label">Current Status</div></div>
<div class="stat-card"><div class="stat-val" style="color:var(--text2);font-size:14px">${timeAgo(svc.last_check)}</div><div class="stat-label">Last Checked</div></div>
</div>`;

                // Grid: chart + heatmap/incidents
                h += `<div class="grid-detail">`;

                // Left: 24h response time chart
                h += `<div class="card"><div class="card-title">24-Hour Response Time History (ms)<div class="legend"><span><span class="ldot" style="background:var(--cyan)"></span> Response</span><span><span class="ldot" style="background:var(--purple)"></span> Degraded</span></div></div>`;
                h += `<div class="chart-box"><svg viewBox="0 0 700 160" preserveAspectRatio="none">`;
                // Degraded area
                h += `<path class="area-fill" d="${makePath(700, 160, valsDeg, true)}" fill="var(--purple)"/>`;
                h += `<path class="area-line" d="${makePath(700, 160, valsDeg, false)}" stroke="var(--purple)"/>`;
                // Response area
                h += `<path class="area-fill" d="${makePath(700, 160, vals24, true)}" fill="var(--cyan)"/>`;
                h += `<path class="area-line" d="${makePath(700, 160, vals24, false)}" stroke="var(--cyan)"/>`;
                // Grid lines
                for (let i = 1; i < 4; i++) { const y = i * 40; h += `<line x1="0" y1="${y}" x2="700" y2="${y}" stroke="var(--border)" stroke-dasharray="4"/>` }
                // Value labels
                const maxRT = Math.max(...vals24);
                h += `<text x="4" y="16" fill="var(--text3)" font-size="9">${Math.round(maxRT)}ms</text>`;
                h += `<text x="4" y="${156}" fill="var(--text3)" font-size="9">0ms</text>`;
                // Peak marker
                const peakIdx = vals24.indexOf(maxRT);
                const peakX = peakIdx * (700 / 47), peakY = 160 - ((maxRT / (maxRT * 1.25)) * 160 * 0.85 + 160 * 0.05);
                h += `<circle cx="${peakX}" cy="${peakY}" r="4" fill="var(--red)" stroke="var(--bg)" stroke-width="2"/>`;
                h += `<text x="${peakX + 8}" y="${peakY - 6}" fill="var(--red)" font-size="9" font-weight="600">${Math.round(maxRT)}ms</text>`;
                h += `</svg></div>`;
                // Time axis
                h += `<div style="display:flex;justify-content:space-between;font-size:9px;color:var(--text3);padding-top:6px"><span>24h ago</span><span>18h</span><span>12h</span><span>6h</span><span>Now</span></div>`;
                h += `</div>`;

                // Right column
                h += `<div>`;

                // Heatmap
                h += `<div class="card"><div class="card-title">Daily Outage Patterns (Last 30 Days)<div class="legend"><span><span class="ldot" style="background:var(--green)"></span> Normal</span><span><span class="ldot" style="background:var(--red)"></span> Major Outage</span></div></div>`;
                h += `<div class="heatmap-grid">`;
                ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(d => h += `<div class="heat-label">${d}</div>`);
                let seed2 = svc.response_time_ms || 42;
                for (let i = 0; i < 35; i++) {
                    seed2 = (seed2 * 31 + 17) % 100;
                    const cls = seed2 < 55 ? 'h-up' : seed2 < 75 ? 'h-deg' : seed2 < 85 ? 'h-down' : 'h-none';
                    const day = i < 30 ? 30 - i : '';
                    h += `<div class="heat-cell ${cls}" title="Day ${day}">${day}</div>`;
                }
                h += `</div></div>`;

                // Incidents for this service
                h += `<div class="card"><div class="card-title">Recent Incidents Timeline</div>`;
                if (svc.status === 'down' || svc.status === 'degraded') {
                    const cls2 = svc.status === 'degraded' ? 'degraded' : '';
                    h += `<div class="inc-card ${cls2}"><div class="inc-title">Incident: ${esc(svc.name)} — ${svc.status}</div><div class="inc-meta"><span>Duration: ongoing</span><span>${timeAgo(svc.last_check)}</span></div><div class="inc-badge ${svc.status}">${svc.status}</div></div>`;
                }
                if (svc.prev_status && svc.prev_status !== 'unknown' && svc.prev_status !== svc.status) {
                    h += `<div class="inc-card resolved"><div class="inc-title">Status changed: ${svc.prev_status} → ${svc.status}</div><div class="inc-meta"><span>${timeAgo(svc.last_check)}</span><span>${esc(svc.message)}</span></div><div class="inc-badge ${svc.status === 'up' ? 'resolved' : svc.status}">${svc.status === 'up' ? 'Resolved' : svc.status}</div></div>`;
                }
                if (svc.status === 'up' && (!svc.prev_status || svc.prev_status === 'unknown' || svc.prev_status === 'up')) {
                    h += `<div class="inc-card resolved"><div class="inc-title">No recent incidents</div><div class="inc-meta"><span>Service has been stable</span></div><div class="inc-badge resolved">Healthy</div></div>`;
                }
                h += `</div>`;

                h += `</div>`; // end right col
                h += `</div>`; // end grid

                // Message detail
                h += `<div class="card" style="margin-top:16px"><div class="card-title">Latest Check Details</div>`;
                h += `<div style="font-size:13px;line-height:1.8">`;
                h += `<div><strong>Service:</strong> ${esc(svc.name)} <code style="background:var(--card2);padding:2px 8px;border-radius:4px;font-size:11px;color:var(--cyan)">${esc(svc.id)}</code></div>`;
                h += `<div><strong>Message:</strong> ${esc(svc.message)}</div>`;
                h += `<div><strong>HTTP Code:</strong> ${svc.http_code || 'N/A'}</div>`;
                h += `<div><strong>Value:</strong> ${svc.value != null ? svc.value : 'N/A'}</div>`;
                h += `</div></div>`;

                app.innerHTML = h;
            }

            async function fetchData() {
                try {
                    const r = await fetch(DATA_URL + '?t=' + Date.now());
                    if (!r.ok) throw 0;
                    allData = await r.json();
                    const svcs = allData.services || [];
                    if (!selectedId && svcs.length) selectedId = svcs[0].id;
                    renderPills(svcs);
                    renderDetail();
                } catch (e) {
                    app.innerHTML = '<div class="no-data"><h3>Waiting for Data</h3><p>Push to GitHub & enable Actions to start monitoring.</p><p style="margin-top:10px"><code>./run-check.sh</code></p></div>';
                }
            }
            fetchData();
            setInterval(fetchData, 300000);
        })();
    </script>
</body>

</html>